(function(y,A,ma){function wa(e){return xa.call(e)==="[object Function]"}function na(e){return xa.call(e)==="[object Array]"}function Ca(e){return e&&xa.call(e)==="[object Object]"}function ya(e){return(e||"").replace(/^\s+|\s+$/g,"")}function za(e,g){var j=false;if(Ca(g)){e=e||{};for(var k in g){var o=g[k];if(e[k]!=o){j=j||{};j[k]=o}}}return j}function ia(e){var g=[];if(e!=null){var j=e.length;if(j==null||typeof e==="string"||wa(e)||e.setInterval)g[0]=e;else for(;j;)g[--j]=e[j]}return g}function C(){var e=
arguments[0]||{},g=1,j=arguments.length,k=false,o;if(typeof e==="boolean"){k=e;e=arguments[1]||{};g=2}if(typeof e!=="object"&&!wa(e))e={};for(;g<j;g++)if((o=arguments[g])!=null)for(var u in o){var s=e[u],t=o[u];if(e!==t)if(k&&t&&typeof t==="object"&&!t.nodeType)e[u]=C(k,s||(t.length!=null?[]:{}),t);else if(t!==ma)e[u]=t}return e}function J(e,g,j){var k,o=0,u=e.length,s=u===ma||wa(e);if(j)if(s)for(k in e){if(g.apply(e[k],j)===false)break}else for(;o<u;){if(g.apply(e[o++],j)===false)break}else if(s)for(k in e){if(g.call(e[k],
k,e[k])===false)break}else for(j=e[0];o<u&&g.call(j,o,j)!==false;j=e[++o]);return e}function oa(e,g,j){for(var k=[],o=0,u=e.length;o<u;o++)!j!==!g(e[o],o)&&k.push(e[o]);return k}function ra(e,g){for(var j=[],k,o=0,u=e.length;o<u;o++){k=g(e[o],o);if(k!=null)j[j.length]=k}return j.concat.apply([],j)}function ca(e){this.type=e;this.timeStamp=(new Date).getTime()}function N(e){this.URL=e;this._setting();this._connect()}function B(e,g){var j=this;g=g||{};var k=j.ws=new WebSocket(e);k.onopen=function(){j.trigger("open",
"success");k.send("subscribe "+g.domain+" "+g.ticket)};k.onclose=function(o){j.trigger("close",[o.data])};k.onmessage=function(o){o=o.data;try{o=o?y.JSON&&y.JSON.parse?y.JSON.parse(o):(new Function("return "+o))():o}catch(u){}j.trigger("message",[o])};k.onerror=function(){j.trigger("error",[])}}function sa(e,g,j){if(typeof g!="undefined"){j=j||{};if(g===null){g="";j.expires=-1}var k="";if(j.expires&&(typeof j.expires=="number"||j.expires.toUTCString)){if(typeof j.expires=="number"){k=new Date;k.setTime(k.getTime()+
j.expires*24*60*60*1E3)}else k=j.expires;k="; expires="+k.toUTCString()}var o=j.path?"; path="+j.path:"",u=j.domain?"; domain="+j.domain:"";j=j.secure?"; secure":"";A.cookie=[e,"=",encodeURIComponent(g),k,o,u,j].join("")}else{g=null;if(A.cookie&&A.cookie!=""){j=A.cookie.split(";");for(k=0;k<j.length;k++){o=ya(j[k]);if(o.substring(0,e.length+1)==e+"="){g=decodeURIComponent(o.substring(e.length+1));break}}}return g}}function G(e,g){this.options=C({},G.defaults,g);this._init(e,g)}function z(e){return e&&
e.split?e.split(","):na(e)?e:parseInt(e)?[parseInt(e)]:[]}function ja(e,g,j){function k(o,u){this.data=o;this.options=C({},k.defaults,u);wa(this._init)&&this._init()}k.defaults=g;ca.on(k);C(k.prototype,j);G[e]=k}function H(e,g){if(typeof e=="string"){e[e]=g;if(g===ma)return H[e]}C(H,e)}var xa=Object.prototype.toString;ca.on=function(){for(var e,g=ca.on.prototype,j=0,k=arguments.length;j<k;j++){e=arguments[j].prototype;e.bind=e.addEventListener=g.addEventListener;e.unbind=e.removeEventListener=g.removeEventListener;
e.trigger=e.dispatchEvent=g.dispatchEvent}};ca.on.prototype={addEventListener:function(e,g){var j=this.__listeners=this.__listeners||{};j[e]=j[e]||[];j[e].push(g);return this},dispatchEvent:function(e,g){var j=this.__listeners=this.__listeners||{};e=e.type?e:new ca(e);j=j[e.type];if(Object.prototype.toString.call(g)==="[object Array]")g.unshift(e);else g=[e,g];if(j)for(var k=0,o=j.length;k<o;k++)j[k].apply(this,g);return this},removeEventListener:function(e,g){var j=this.__listeners=this.__listeners||
{};if(j[e])if(g){j=j[e];for(var k=j.length;k--;)j[k]===g&&j.splice(k,1)}else delete j[e];return this}};var T=function(){function e(w){var m={};for(var E in e.settings)m[E]=e.settings[E];if(w)for(E in w)m[E]=w[E];var O,Y,Z,F=m.type.toUpperCase(),M=o.test(F),V,W,Fa=y,X;m.url=m.url.replace(aa,"");m.context=w&&w.context!=null?w.context:m;if(m.data&&m.processData&&typeof m.data!=="string")m.data=g(m.data,m.traditional);var da=P.exec(m.url);E=y.location;da=da&&(da[1]&&da[1]!==E.protocol||da[2]!==E.host);
/https?:/i.test(E.protocol)||(da=false);da=m.forceRemote?true:da;if(m.dataType==="jsonp"&&!da)m.dataType="json";if(m.dataType==="jsonp"){if(F==="GET")s.test(m.url)||(m.url+=(t.test(m.url)?"&":"?")+(m.jsonp||"callback")+"=?");else if(!m.data||!s.test(m.data))m.data=(m.data?m.data+"&":"")+(m.jsonp||"callback")+"=?";m.dataType="json"}if(m.dataType==="json"&&(m.data&&s.test(m.data)||s.test(m.url))){O=m.jsonpCallback||"jsonp"+j++;if(m.data)m.data=(m.data+"").replace(s,"="+O+"$1");m.url=m.url.replace(s,
"="+O+"$1");m.dataType="script";var Aa=y[O],pa=false;y[O]=function(fa){if(!pa){pa=true;if(Object.prototype.toString.call(Aa)==="[object Function]")Aa(fa);else{y[O]=ma;try{delete y[O]}catch(ta){}}Z=fa;L.handleSuccess(m,D,Y,Z);L.handleComplete(m,D,Y,Z);V&&V.removeChild(X);W&&W.parentNode&&W.parentNode.removeChild(W)}}}if(m.dataType==="script"&&m.cache===null)m.cache=false;if(m.cache===false&&F==="GET"){var Ba=(new Date).getTime(),Da=m.url.replace(K,"$1_="+Ba);m.url=Da+(Da===m.url?(t.test(m.url)?"&":
"?")+"_="+Ba:"")}if(m.data&&F==="GET")m.url+=(t.test(m.url)?"&":"?")+m.data;m.global&&L.active++;if(m.dataType==="script"&&F==="GET"&&da){w=false;if(O&&m.async&&!k)if(y._fragmentProxy)V=W=A.createDocumentFragment();else{w=true;if(m.url.slice(0,1)=="/")m.url=E.protocol+"//"+E.host+(E.port?":"+E.port:"")+m.url;else if(!/^https?:\/\//i.test(m.url)){E=E.href;F=/([^?#]+)\//.exec(E);m.url=(F?F[1]:E)+"/"+m.url}m.url=m.url.replace("="+O,"=parent."+O);W=A.createElement("iframe");W.style.position="absolute";
W.style.left="-100px";W.style.top="-100px";W.style.height="1px";W.style.width="1px";W.style.visibility="hidden";A.body.insertBefore(W,A.body.firstChild);Fa=W.contentWindow}var ka=function(){var fa=Fa.document;V=V||fa.getElementsByTagName("head")[0]||fa.documentElement;X=fa.createElement("script");if(m.scriptCharset)X.charset=m.scriptCharset;X.src=m.url;if(k)X.async=m.async;if(O)X.onload=X.onerror=X.onreadystatechange=function(){if(!pa&&(!this.readyState||this.readyState==="loaded"||this.readyState===
"complete")){pa=true;L.handleError(m,D,"error","load error");V&&X.parentNode&&V.removeChild(X);W&&W.parentNode&&W.parentNode.removeChild(W)}};else{var ta=false;X.onload=X.onreadystatechange=function(){if(!ta&&(!this.readyState||this.readyState==="loaded"||this.readyState==="complete")){ta=true;L.handleSuccess(m,D,Y,Z);L.handleComplete(m,D,Y,Z);X.onload=X.onreadystatechange=null;V&&X.parentNode&&V.removeChild(X)}}}V.insertBefore(X,V.firstChild)};w?setTimeout(function(){ka()},0):ka();return ma}var ua=
false,D=m.xhr();if(D){m.username?D.open(F,m.url,m.async,m.username,m.password):D.open(F,m.url,m.async);try{if(m.data!=null&&!M||w&&w.contentType)D.setRequestHeader("Content-Type",m.contentType);if(m.ifModified){L.lastModified[m.url]&&D.setRequestHeader("If-Modified-Since",L.lastModified[m.url]);L.etag[m.url]&&D.setRequestHeader("If-None-Match",L.etag[m.url])}da||D.setRequestHeader("X-Requested-With","XMLHttpRequest");D.setRequestHeader("Accept",m.dataType&&m.accepts[m.dataType]?m.accepts[m.dataType]+
", */*; q=0.01":m.accepts._default)}catch(Ia){}if(m.beforeSend&&m.beforeSend.call(m.context,D,m)===false){m.global&&L.active--;D.abort();return false}m.global&&L.triggerGlobal(m,"ajaxSend",[D,m]);var ga=D.onreadystatechange=function(fa){if(!D||D.readyState===0||fa==="abort"){ua||L.handleComplete(m,D,Y,Z);ua=true;if(D)D.onreadystatechange=L.noop}else if(!ua&&D&&(D.readyState===4||fa==="timeout")){ua=true;D.onreadystatechange=L.noop;Y=fa==="timeout"?"timeout":!L.httpSuccess(D)?"error":m.ifModified&&
L.httpNotModified(D,m.url)?"notmodified":"success";var ta;if(Y==="success")try{Z=L.httpData(D,m.dataType,m)}catch(a){Y="parsererror";ta=a}if(Y==="success"||Y==="notmodified")O||L.handleSuccess(m,D,Y,Z);else L.handleError(m,D,Y,ta);O||L.handleComplete(m,D,Y,Z);fa==="timeout"&&D.abort();if(m.async)D=null}};try{var R=D.abort;D.abort=function(){D&&R.call&&R.call(D);ga("abort")}}catch(ba){}m.async&&m.timeout>0&&setTimeout(function(){D&&!ua&&ga("timeout")},m.timeout);try{D.send(M||m.data==null?null:m.data)}catch(Ga){L.handleError(m,
D,null,Ga);L.handleComplete(m,D,Y,Z)}m.async||ga();return D}}function g(w){var m=[];if(typeof w=="object"){for(var E in w)m[m.length]=encodeURIComponent(E)+"="+encodeURIComponent(w[E]);return m.join("&").replace(Q,"+")}return w}var j=(new Date).getTime(),k=typeof A.createElement("script").async==="boolean",o=/^(?:GET|HEAD|DELETE)$/,u=/\S/,s=/\=\?(&|$)/,t=/\?/,K=/([?&])_=[^&]*/,P=/^(\w+:)?\/\/([^\/?#]+)/,Q=/%20/g,aa=/#.*$/;y._fragmentProxy=false;var S=A.createDocumentFragment(),ea=A.createElement("script");
try{ea.appendChild(A.createTextNode("window._fragmentProxy = true"))}catch(va){ea.text="window._fragmentProxy = true"}S.appendChild(ea);S=ea=null;e.param=g;var L={noop:function(){},active:0,lastModified:{},etag:{},handleError:function(w,m,E,O){w.error&&w.error.call(w.context,m,E,O);w.global&&L.triggerGlobal(w,"ajaxError",[m,w,O])},handleSuccess:function(w,m,E,O){w.success&&w.success.call(w.context,O,E,m);w.global&&L.triggerGlobal(w,"ajaxSuccess",[m,w])},handleComplete:function(w,m,E){w.complete&&
w.complete.call(w.context,m,E);w.global&&L.triggerGlobal(w,"ajaxComplete",[m,w]);w.global&&L.active--},triggerGlobal:function(){},httpSuccess:function(w){try{return!w.status&&location.protocol==="file:"||w.status>=200&&w.status<300||w.status===304||w.status===1223}catch(m){}return false},httpNotModified:function(w,m){var E=w.getResponseHeader("Last-Modified"),O=w.getResponseHeader("Etag");if(E)L.lastModified[m]=E;if(O)L.etag[m]=O;return w.status===304},httpData:function(w,m,E){var O=w.getResponseHeader("content-type")||
"",Y=m==="xml"||!m&&O.indexOf("xml")>=0;w=Y?w.responseXML:w.responseText;Y&&w.documentElement.nodeName==="parsererror"&&L.error("parsererror");if(E&&E.dataFilter)w=E.dataFilter(w,m);if(typeof w==="string")if(m==="json"||!m&&O.indexOf("json")>=0)w=w?y.JSON&&y.JSON.parse?y.JSON.parse(w):(new Function("return "+w))():w;else if(m==="script"||!m&&O.indexOf("javascript")>=0)if(w&&u.test(w)){m=A.getElementsByTagName("head")[0]||A.documentElement;E=A.createElement("script");E.type="text/javascript";try{E.appendChild(A.createTextNode(w))}catch(Z){E.text=
w}m.insertBefore(E,m.firstChild);m.removeChild(E)}return w}};e.settings={url:location.href,global:true,type:"GET",contentType:"application/x-www-form-urlencoded",processData:true,async:true,xhr:function(){return new y.XMLHttpRequest},accepts:{xml:"application/xml, text/xml",html:"text/html",script:"text/javascript, application/javascript",json:"application/json, text/javascript",text:"text/plain",_default:"*/*"}};e.setup=function(w){if(w)for(var m in w)e.settings[m]=w[m]};if(y.ActiveXObject)e.settings.xhr=
function(){if(y.location.protocol!=="file:")try{return new y.XMLHttpRequest}catch(w){}try{return new y.ActiveXObject("Microsoft.XMLHTTP")}catch(m){}};return e}(),la=y.JSON?y.JSON:function(){function e(k){return j[k]||"\\u00"+Math.floor(k.charCodeAt()/16).toString(16)+(k.charCodeAt()%16).toString(16)}function g(k){switch(Object.prototype.toString.call(k)){case "[object String]":return'"'+k.replace(/[\x00-\x1f\\"]/g,e)+'"';case "[object Array]":for(var o=[],u=k.length,s=0;s<u;s++)o.push(g(k[s]));return"["+
o.join(",")+"]";case "[object Object]":o=[];for(u in k)(s=g(k[u]))&&o.push(g(u)+":"+s);return"{"+o+"}";case "[object Number]":case "[object Boolean]":return String(k);case false:return"null"}return null}var j={"\u0008":"\\b","\t":"\\t","\n":"\\n","\u000c":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"};return{stringify:g,parse:function(k){k=k.toString();if(!k||!k.length)return null;return(new Function("return "+k))()}}}();N.prototype={readyState:0,send:function(){},_setting:function(){this.readyState=N.CLOSED;
this._onPolling=this._connecting=false;this._pollTimer=null;this._failTimes=this._pollingTimes=0},_connect:function(){var e=this;if(e._connecting)return e;e.readyState=N.CONNECTING;e._connecting=true;e._onPolling||y.setTimeout(function(){e._startPolling()},300);return e},close:function(){this._pollTimer&&clearTimeout(this._pollTimer);this._setting();return this},_onConnect:function(){this.readyState=N.OPEN;this.trigger("open","success")},_onClose:function(e){var g=this;g._setting();setTimeout(function(){g.trigger("close",
[e])},1E3)},_onData:function(e){this.trigger("message",[e])},_onError:function(e){var g=this;g._setting();setTimeout(function(){g.trigger("error",[e])},1E3)},_startPolling:function(){if(this._connecting){this._onPolling=true;this._pollingTimes++;T({url:this.URL,dataType:"jsonp",cache:false,context:this,success:this._onPollSuccess,error:this._onPollError})}},_onPollSuccess:function(e){var g=this;g._onPolling=false;if(g._connecting)if(e){g._pollingTimes==1&&g._onConnect();g._onData(e);g._failTimes=
0;g._pollTimer=y.setTimeout(function(){g._startPolling()},200)}else return g._onError("error data")},_onPollError:function(e){var g=this;g._onPolling=false;if(g._connecting){g._failTimes++;if(g._pollingTimes==1)g._onError("can not connect.");else if(g._failTimes>1)g._onClose(e);else g._pollTimer=y.setTimeout(function(){g._startPolling()},200)}}};N.CONNECTING=0;N.OPEN=1;N.CLOSED=2;ca.on(N);B.prototype={readyState:0,send:function(){},close:function(){this.ws.close()}};B.enable=!!y.WebSocket;B.CONNECTING=
0;B.OPEN=1;B.CLOSED=2;ca.on(B);ca.on(G);G.csrf_token="";G.OFFLINE=0;G.BEFOREONLINE=1;G.ONLINE=2;C(G.prototype,{state:G.OFFLINE,_init:function(){var e=this.options;this.data={user:{presence:"offline",show:"unavailable"}};T.settings.dataType=e.jsonp?"jsonp":"json";this.status=new G.status;this.setting=new G.setting;this.buddy=new G.buddy;this.room=new G.room(null,this.data);this.history=new G.history(null,this.data);this._initEvents()},_createConnect:function(){var e=this,g=e.data.connection;e.connection=
e.options.connectionType!="jsonpd"&&g.websocket&&B.enable?new B(g.websocket,g):new N(g.server+(/\?/.test(g)?"&":"?")+T.param({ticket:g.ticket,domain:g.domain}));e.connection.bind("connect",function(){}).bind("message",function(j,k){e.handle(k)}).bind("error",function(){e._stop("connect","Connect Error")}).bind("close",function(){e._stop("connect","Disconnect")})},setUser:function(e){C(this.data.user,e)},_ready:function(e){this.state=G.BEFOREONLINE;this.trigger("beforeOnline",[e])},_go:function(){var e=
this.data,g=this.history,j=this.buddy,k=this.room;this.state=G.ONLINE;g.options.userInfo=e.user;J(e.buddies,function(u,s){g.init("chat",s.id,s.history)});j.set(e.buddies);J(e.rooms,function(u,s){g.init("grpchat",s.id,s.history)});j=this.setting.get("blocked_rooms");var o=e.rooms;na(j)&&o&&J(j,function(u,s){o[s]&&(o[s].blocked=true)});k.set(o);k.options.ticket=e.connection.ticket;this.trigger("online",[e]);this._createConnect();if((e=e.new_messages)&&e.length){J(e,function(u,s){s["new"]=true});this.trigger("message",
[e])}},_stop:function(e,g){if(this.state!==G.OFFLINE){this.state=G.OFFLINE;this.data.user.presence="offline";this.data.user.show="unavailable";this.buddy.clear();this.trigger("offline",[e,g])}},autoOnline:function(){return!this.status.get("o")},_initEvents:function(){function e(t){var K={id:t.from,presence:t.type};if(t.show)K.show=t.show;if(t.nick)K.nick=t.nick;if(t.status)K.status=t.status;return K}function g(t){return t.type=="online"||t.type=="offline"||t.type=="show"}function j(t){return t.type==
"join"||t.type=="leave"}var k=this,o=k.history,u=k.buddy,s=k.room;k.bind("message",function(t,K){for(var P=[],Q=K.length,aa=k.data.user.id,S,ea,va,L=0;L<Q;L++){S=K[L];va=S.type;ea=va=="chat"?S.to==aa?S.from:S.to:S.to;S.id=ea;if(va=="chat"&&!S["new"]){ea={id:ea,presence:"online"};if(S.nick&&S.to==aa)ea.nick=S.nick;P.push(ea)}}if(P.length){u.presence(P);u.complete()}o.set(K)});k.bind("presence",function(t,K){u.presence(ra(oa(K,g),e));K=oa(K,j);for(var P=K.length-1;P>=0;P--){var Q=K[P];Q.type=="leave"?
s.removeMember(Q.to||Q.status,Q.from):s.addMember(Q.to||Q.status,{id:Q.from,nick:Q.nick})}})},handle:function(e){if(e.messages&&e.messages.length){for(var g=e.messages,j=[],k=[],o=0;o<g.length;o++){var u=g[o];if(u.body&&u.body.indexOf("webim-event:")==0){u.event=u.body.replace("webim-event:","").split("|,|");k.push(u)}else j.push(u)}j.length&&this.trigger("message",[j]);k.length&&this.trigger("event",[k])}e.presences&&e.presences.length&&this.trigger("presence",[e.presences]);e.statuses&&e.statuses.length&&
this.trigger("status",[e.statuses])},sendMessage:function(e,g){e.ticket=this.data.connection.ticket;this.trigger("sendMessage",[e]);T({type:"post",cache:false,url:H("message"),data:C({csrf_token:G.csrf_token},e),success:g,error:g})},sendStatus:function(e,g){e.ticket=this.data.connection.ticket;this.trigger("sendStatus",[e]);T({type:"post",cache:false,url:H("status"),data:C({csrf_token:G.csrf_token},e),success:g,error:g})},sendPresence:function(e,g){e.ticket=this.data.connection.ticket;this.data.user.show=
e.show;this.status.set("s",e.show);this.trigger("sendPresence",[e]);T({type:"post",cache:false,url:H("presence"),data:C({csrf_token:G.csrf_token},e),success:g,error:g})},online:function(e){var g=this,j=g.status;if(g.state===G.OFFLINE){var k=[],o=[],u=j.get("tabs"),s=j.get("tabIds");s&&s.length&&u&&J(u,function(t){t[0]=="b"&&k.push(t.slice(2));t[0]=="r"&&o.push(t.slice(2))});e=C({buddy_ids:k.join(","),room_ids:o.join(","),csrf_token:G.csrf_token,show:j.get("s")||"available"},e);g._ready(e);j.set("o",
false);j.set("s",e.show);T({type:"post",cache:false,url:H("online"),data:e,success:function(t){if(t)if(t.success){t.user=C(g.data.user,t.user,{presence:"online"});g.data=t;g._go()}else g._stop("online",t.error_msg);else g._stop("online","Not Found")},error:function(){g._stop("online","Not Found")}})}},offline:function(){var e=this.data;if(this.state!==G.OFFLINE){this.status.set("o",true);this.connection.close();this._stop("offline","offline");T({type:"post",cache:false,url:H("offline"),data:{status:"offline",
csrf_token:G.csrf_token,ticket:e.connection.ticket}})}},_deactivate:function(){var e=this.data;!e||!e.connection||!e.connection.ticket||T({type:"get",cache:false,url:H("deactivate"),data:{ticket:e.connection.ticket,csrf_token:G.csrf_token}})}});y.webim=G;C(G,{version:"1.1.0",defaults:{},log:function(){var e=new Date;["[",e.getHours(),":",e.getMinutes(),":",e.getSeconds(),"-",e.getMilliseconds(),"]"].join("");if(y&&y.console)y.console.log.apply(null,arguments);else y&&y.runtime&&y.air&&y.air.Introspector&&
y.air.Introspector.Console.log.apply(null,arguments)},idsArray:z,now:function(){return(new Date).getTime()},isFunction:wa,isArray:na,isObject:Ca,trim:ya,makeArray:ia,extend:C,each:J,inArray:function(e,g){for(var j=0,k=g.length;j<k;j++)if(g[j]===e)return j;return-1},grep:oa,map:ra,JSON:la,ajax:T,comet:N,socket:B,model:ja,route:H,ClassEvent:ca});ja("setting",{data:{play_sound:true,buddy_sticky:true,minimize_layout:true,msg_auto_pop:true,temporary_rooms:[],blocked_rooms:[]}},{_init:function(){this.data=
C({},this.options.data,this.data)},get:function(e){return this.data[e]},set:function(e,g){var j=this,k=e;if(e){if(typeof e=="string"){k={};k[e]=g}var o=j.data,u=za(o,k);if(u){J(u,function(s,t){j.trigger("update",[s,t])});k=C({},o,k);j.data=k;T({type:"post",url:H("setting"),cache:false,data:{data:la.stringify(k),csrf_token:G.csrf_token}})}}}});ja("status",{key:"_webim"},{_init:function(){var e=this.data,g=this.options.key;if(e)this._save(e);else this.data=(e=y.localStorage?y.localStorage.getItem(g):
sa(g))?la.parse(e):{}},set:function(e,g){var j=e;if(typeof e=="string"){j={};j[e]=g}var k=this.data;za(k,j)&&this._save(C({},k,j))},get:function(e){return this.data[e]},clear:function(){this._save({})},_save:function(e){var g=this.options.key;this.data=e;e=la.stringify(e);y.localStorage?y.localStorage.setItem(g,e):sa(g,e,{path:"/",domain:A.domain})}});ja("buddy",{active:true},{_init:function(){this.data=this.data||[];this.dataHash={};this.set(this.data)},clear:function(){this.data=[];this.dataHash=
{}},count:function(e){var g=this.dataHash,j=0,k;for(var o in g)if(Ca(e)){k=true;for(var u in e)if(e[u]!=g[o][u])k=false;k&&j++}else j++;return j},get:function(e){return this.dataHash[e]},all:function(e){return e?oa(this.data,function(g){return g.show!="invisible"&&g.presence=="online"}):this.data},complete:function(){var e=this.dataHash,g=[],j;for(var k in e){j=e[k];if(j.incomplete){j.incomplete=false;g.push(k)}}this.load(g)},update:function(e){this.load(e)},presence:function(e){var g=this.dataHash;
e=na(e)?e:[e];for(var j in e){var k=e[j];k.presence=k.presence=="offline"?"offline":"online";k.incomplete=!g[k.id]}this.set(e)},load:function(e){e=z(e);e.length&&T({type:"get",url:H("buddies"),cache:false,data:{ids:e.join(","),csrf_token:G.csrf_token},context:this,success:this.set})},set:function(e){var g=this.data,j=this.dataHash,k={};e=e||[];var o,u;for(var s in e){o=e[s];if(id=o.id){if(!j[id]){o.presence=o.presence||"online";o.show=o.show?o.show:o.presence=="offline"?"unavailable":"available";
j[id]={};g.push(j[id])}o.incomplete=!!o.incomplete;if(u=za(j[id],o)){o=u.presence||"update";k[o]=k[o]||[];C(j[id],u);k[o].push(j[id])}}}for(var t in k)this.trigger(t,[k[t]]);this.options.active&&this.complete()}});(function(){ja("room",{},{_init:function(){this.data=this.data||[];this.dataHash={}},get:function(e){return this.dataHash[e]},all:function(e){return e?oa(this.data,function(g){return g.temporary}):this.data},block:function(e){var g=this.dataHash[e];if(g&&!g.blocked){g.blocked=true;var j=
[];J(this.dataHash,function(k,o){!o.temporary&&o.blocked&&j.push(o.id)});this.trigger("block",[e,j])}},unblock:function(e){var g=this.dataHash[e];if(g&&g.blocked){g.blocked=false;var j=[];J(this.dataHash,function(k,o){!o.temporary&&o.blocked&&j.push(o.id)});this.trigger("unblock",[e,j])}},set:function(e){var g=this,j=g.data,k=g.dataHash;J(e,function(o,u){var s=u.id;if(s){u.members=u.members||[];u.count=u.count||0;u.all_count=u.all_count||0;if(k[s])C(k[s],u);else{k[s]=u;j.push(u)}g.trigger("join",
[k[s]])}})},addMember:function(e,g){var j=this;if(na(g))J(g,function(t,K){j.addMember(e,K)});else{var k=j.dataHash[e];if(k){for(var o=k.members,u,s=o.length;s--;)if(o[s].id==g.id)u=o[s];if(!u){g.nick=g.nick;o.push(g);k.count=o.length;j.trigger("addMember",[e,g])}}}},removeMember:function(e,g){var j=this.dataHash[e];if(j){for(var k=j.members,o,u=k.length;u--;)if(k[u].id==g){o=k[u];k.splice(u,1);j.count--}o&&this.trigger("removeMember",[e,o])}},initMember:function(e){var g=this.dataHash[e];if(g&&!g.initMember){g.initMember=
true;this.loadMember(e)}},loadMember:function(e){var g=this,j=g.options;T({type:"get",cache:false,url:H("members"),data:{ticket:j.ticket,id:e,csrf_token:G.csrf_token},success:function(k){g.addMember(e,k)}})},join:function(e,g,j){var k=this,o=k.options;T({type:"post",cache:false,url:H("join"),data:{ticket:o.ticket,id:e,nick:g||"",csrf_token:G.csrf_token},success:function(u){k.initMember(e);k.set([u]);j&&j(u)}})},leave:function(e){var g=this.options,j=this.dataHash[e],k=g.user;if(j){j.initMember=false;
T({type:"post",cache:false,url:H("leave"),data:{ticket:g.ticket,id:e,nick:k.nick,csrf_token:G.csrf_token}});this.trigger("leave",[j])}},clear:function(){}})})();ja("history",{},{_init:function(){this.data=this.data||{};this.data.chat=this.data.chat||{};this.data.grpchat=this.data.grpchat||{}},get:function(e,g){return this.data[e][g]},set:function(e){var g=this.data,j={chat:{},grpchat:{}};e=ia(e);var k=e.length,o,u,s=this.options.userInfo.id;if(k){for(var t=0;t<k;t++){o=e[t];K=o.type;if((u=K=="chat"?
o.to==s?o.from:o.to:o.to)&&K){j[K][u]=j[K][u]||[];j[K][u].push(o)}}for(var K in j)for(u in j[K]){o=j[K][u];if(g[K][u]){g[K][u]=g[K][u].concat(o);this._triggerMsg(K,u,o)}else this.load(K,u)}}},_triggerMsg:function(e,g,j){this.trigger(e,[g,j])},clear:function(e,g){this.data[e][g]=[];this.trigger("clear",[e,g]);T({url:H("clear"),type:"post",cache:false,data:{type:e,id:g,csrf_token:G.csrf_token}})},download:function(e,g){var j=H("download"),k=A.createElement("iframe"),o=new Date,u=[];o={id:g,type:e,time:(new Date).getTime(),
date:o.getFullYear()+"-"+(o.getMonth()+1)+"-"+o.getDate()};for(var s in o)u[u.length]=encodeURIComponent(s)+"="+encodeURIComponent(o[s]);j+=(/\?/.test(j)?"&":"?")+u.join("&");k.setAttribute("src",j);k.style.display="none";A.body.appendChild(k)},init:function(e,g,j){if(na(j)){this.data[e][g]=j;this._triggerMsg(e,g,j)}},load:function(e,g){var j=this;j.data[e][g]=[];T({url:H("history"),cache:false,type:"get",data:{type:e,id:g,csrf_token:G.csrf_token},success:function(k){j.init(e,g,k)}})}})})(window,
document);
(function(y,A,ma){function wa(){return false}function na(a){var b="";if(a.length==0)return"";b=a.replace(/&/g,"&amp;");b=b.replace(/</g,"&lt;");b=b.replace(/>/g,"&gt;");b=b.replace(/    /g,"&nbsp;");b=b.replace(/\'/g,"&#39;");b=b.replace(/\"/g,"&quot;");return b=b.replace(/\n/g,"<br />")}function Ca(a){return/^http:\/\/[A-Za-z0-9]+\.[A-Za-z0-9]+[\/=\?%\-&_~`@[\]\':+!]*([^<>\"])*$/.test(a)}function ya(a){return a?a.replace(/<(?:.|\s)*?>/g,""):""}function za(a,b){for(var c=[];a;a=a.nextSibling)a.nodeType==1&&
a!=b&&c.push(a);return c}function ia(a,b){return a&&RegExp("(^|\\s+)"+b+"(\\s+|$)").test(a.className)}function C(a,b){if(a)ia(a,b)||(a.className+=" "+b)}function J(a,b){a&&(a.className=a.className.replace(RegExp("(^|\\s+)("+b.split(/\s+/).join("|")+")(?=(\\s+|$))","g")," "))}function oa(a,b,c){a&&(a.className=a.className.replace(RegExp("(^|\\s+)("+b.split(/\s+/).join("|")+")(?=(\\s+|$))","g")," ")+" "+c)}function ra(a,b,c){z(a,"mouseover",function(){C(this,b);c&&J(this,c)});z(a,"mouseout",function(){J(this,
b);c&&C(this,c)})}function ca(a,b,c){if(typeof c==="boolean")c?C(a,b):J(a,b);else ia(a,b)?J(a,b):C(a,b)}function N(a){a&&a.style&&(a.style.display="block")}function B(a){a&&a.style&&(a.style.display="none")}function sa(a){a&&a.parentNode&&a.parentNode.removeChild(a)}function G(a,b){var c=a.childNodes;for(i=0;i<c.length;i++)a.removeChild(c[i]);typeof b==="string"?a.innerHTML=b:a.appendChild(b)}function z(a,b,c){if(a.addEventListener)a.addEventListener(b,c,false);else{a["e"+b+c]=c;a[b+c]=function(){return a["e"+
b+c](y.event)};a.attachEvent("on"+b,a[b+c])}}function ja(a){if(a){a.stopPropagation&&a.stopPropagation();a.cancelBubble=true}}function H(a){if(a){a.preventDefault&&a.preventDefault();a.returnValue=false}}function xa(a){if(!a.target)a.target=a.srcElement||A;if(a.target.nodeType===3)a.target=a.target.parentNode;return a.target}function T(a){a.setAttribute("unselectable","on");a.style.MozUserSelect="none";a.style.OUserSelect="none";a.style.WebkitUserSelect="none";z(a,"selectstart",wa)}function la(){if(!pa){pa=
true;if(Ba){for(var a,b=0;a=Ba[b++];)a();Ba=null}}}function e(){if(!Da){Da=true;if(A.readyState==="complete")return la();if(A.addEventListener)A.addEventListener("DOMContentLoaded",function(){A.removeEventListener("DOMContentLoaded",arguments.callee,false);la()},false);else if(A.attachEvent){A.attachEvent("onreadystatechange",function(){if(A.readyState==="complete"){A.detachEvent("onreadystatechange",arguments.callee);la()}});A.documentElement.doScroll&&y==y.top&&function(){if(!pa){try{A.documentElement.doScroll("left")}catch(a){setTimeout(arguments.callee,
0);return}la()}}()}z(y,"load",la)}}function g(a){var b=new Date;b.setTime(a?parseFloat(a)+g.timeSkew:(new Date).getTime());this.date=b}function j(a,b,c){if(a.addEventListener)a.addEventListener(b,c,false);else{a["e"+b+c]=c;a[b+c]=function(){return a["e"+b+c](y.event)};a.attachEvent("on"+b,a[b+c])}}function k(a){a&&a.parentNode&&a.parentNode.removeChild(a)}function o(a){return a?y.JSON&&y.JSON.parse?y.JSON.parse(a):(new Function("return "+a))():a}function u(a,b){j(a,"submit",function(){function c(){try{var p=
f.contentWindow.name||null;if(p!=null){k(d);b&&b(o(p))}else throw Error("Empty data");}catch(n){k(d);b&&b({error:"Retrieve data error"})}}a.setAttribute("target","_upload_form13123");var d=A.createElement("div");d.innerHTML='<iframe name="_upload_form13123" id="_upload_form13123" style="display:none;" scrolling="no" frameborder="0"></iframe>';var f=d.firstChild;A.body.appendChild(d);if(y.postMessage){var h=function(p){var n=y,r=h;if(n.addEventListener)n.removeEventListener("message",r,false);else{n.detachEvent("onmessage",
n["message"+r]);n["message"+r]=null}k(d);b&&b(o(p.data))};j(y,"message",h)}else{var l=false;j(f,"load",function(){if(l)y.attachEvent||c();else{l=true;f.contentWindow.location="about:blank"}});if(y.attachEvent)f.onreadystatechange=function(){l&&c()}}})}function s(a,b,c){c=F({locale:s.locale},c);c=s.dictionary[c.locale];O(c)||(c={});a=c[a]===ma?a:c[a];if(b){D=b;for(var d in b)a=a.replace(/\{\{(.*?)\}\}/g,Ia)}return a}function t(a,b){this.element=a;this.options=F({},t.defaults,b);this._init()}function K(a){a=
a.getElementsByTagName("*");for(var b,c,d={},f=a.length-1;f>-1;f--){b=a[f];if((c=b.id)&&c.indexOf(":")==0)d[c.substring(1,c.length)]=b}return d}function P(a){var b=A.createElement("div");b.innerHTML=a;return b=b.firstChild}function Q(a,b,c){function d(f,h){this.id=Ga++;this.name=a;this.className="webim-"+a;this.options=F({},d.defaults,h);if(this.element=f||this.template&&P(this.template())||this.options.template&&P(R(this.options.template))){this.options.className&&C(this.element,this.options.className);
this.$=K(this.element)}m(this._init)&&this._init();m(this._initEvents)&&this._initEvents()}d.defaults=b;X.on(d);F(d.prototype,Q.prototype,c);t[a]=d}function aa(a,b){t.apps[a]=b||{}}function S(a,b){return b?a=="b"||a=="buddy"||a=="chat"?"b_"+b:"r_"+b:a}function ea(a){return a=="b"||a=="buddy"||a=="chat"?"buddy":"room"}function va(){A.selection&&(this.caretPos=A.selection.createRange())}function L(){return"xx4xyxyxxxyxyyxy".replace(/[xy]/g,function(a){var b=Math.random()*16|0;return(a=="x"?b:b&3|8).toString(16)})}
var w=webim.idsArray,m=webim.isFunction,E=webim.isArray,O=webim.isObject,Y=webim.trim,Z=webim.makeArray,F=webim.extend,M=webim.each,V=webim.grep,W=webim.ajax,Fa=webim.model,X=webim.ClassEvent,da=webim.route,Aa=webim.map,pa=false,Ba=[],Da=false;g.timeSkew=0;g.init=function(a){g.timeSkew=(new Date).getTime()-parseFloat(a)};F(g.prototype,{getTime:function(){var a=this.date,b=a.getHours();a=a.getMinutes();if(a<10)a="0"+a;return b+":"+a+""},getDay:function(a){var b=this.date;if(a){a=new Date;a.setHours(0);
a.setMinutes(0);a.setSeconds(0);a.setMilliseconds(0);a=a.getTime()-b.getTime();if(a<=0)return s("dt:today");else if(a<864E5)return s("dt:yesterday")}return s("dt:monthdate",{month:s(["dt:january","dt:february","dt:march","dt:april","dt:may","dt:june","dt:july","dt:august","dt:september","dt:october","dt:november","dt:december"][b.getMonth()]),date:b.getDate()})}});var ka=function(){var a=true,b={lib:"sound.swf",msg:"sound/msg.mp3"};return{enable:function(){a=true},disable:function(){a=false},init:function(c){F(b,
c);if(!y.Audio&&navigator.userAgent.indexOf("MSIE")>=0)A.getElementById("webim-flashlib-c").innerHTML='<bgsound id="webim-bgsound" src="#" loop="1">'},play:function(c){c=Ca(c)?c:b[c];if(a)if(y.Audio){if(!d)var d=new Audio;d.src=c;d.play()}else if(navigator.userAgent.indexOf("MSIE")>=0)try{A.getElementById("webim-bgsound").src=c?c:"/sound/sound.mp3"}catch(f){}}}}(),ua=function(){var a=false;z(y,"focus",function(){a=false});z(y,"blur",function(){a=true});var b=A.title,c=0,d=false;return function(f,
h){if(a){if(l){clearInterval(l);c=0;d=false}var l=setInterval(function(){c++;d=!d;if(c==h||!a){clearInterval(l);c=0;d=false}A.title=d?"["+f+"]"+b:b},1500)}}}(),D={},Ia=function(a,b){return D[b]||""};s.locale="zh-CN";s.dictionary={};s.store=function(a,b){var c=s.dictionary;O(c[a])||(c[a]={});F(c[a],b)};X.on(t);F(t.prototype,{render:function(){var a=this,b=a.layout;a.element.insertBefore(b.element,a.element.firstChild);setTimeout(function(){a.initSound()},1E3);b.buildUI()},_init:function(){var a=this.im=
new webim(null,this.options.imOptions),b=this.options;this.layout=this.addApp(b.layout||"layout",b.layoutOptions);a.setting.get("play_sound")?ka.enable():ka.disable();a.bind("online",function(c,d){g.init(d.server_time)});a.setting.bind("update",function(c,d,f){if("play_sound"==d)f?ka.enable():ka.disable()})},addApp:function(a,b){var c=t.apps[a];if(c)return m(c)&&c.apply(this,[b])},initSound:function(a){ka.init(a||this.options.soundUrls)}});var ga=function(a,b){if(b===ma)return parseInt(a.innerHTML);
else if(b){b=typeof b=="number"?b:parseInt(a.innerHTML)+parseInt(b);a.innerHTML=b.toString();N(a)}else{a.innerHTML="0";B(a)}return b},R=function(){function a(d,f){return b&&b[f]!=ma?b[f]:s(f)}var b=null,c=/\<\%\=(.*?)\%\>/ig;return function(d,f){if(!d)return"";b=f;return d.replace(c,a)}}(),ba={add:function(a,b,c){a=t[a].prototype;for(var d in c){a.plugins[d]=a.plugins[d]||[];a.plugins[d].push([b,c[d]])}},call:function(a,b,c){if((b=a.plugins[b])&&a.element.parentNode)for(var d=0;d<b.length;d++)a.options[b[d][0]]&&
b[d][1].apply(a.element,c)}},Ga=1;F(Q.prototype,{_init:function(){}});F(t,{version:"3.0.1",widget:Q,app:aa,plugin:ba,i18n:s,date:g,ready:function(a){e();pa?a():Ba.push(a)},createElement:P,defaults:{},apps:{}});webim.ui=t;Q("window",{isMinimize:false,minimizable:true,maximizable:false,closeable:true,sticky:true,titleVisibleLength:12,count:0,template:'<div id=":webim-window" class="webim-window ui-widget">                                            <div class="webim-window-tab-wrap">                                            <div id=":tab" class="webim-window-tab ui-state-default">                                            <div class="webim-window-tab-inner">                                                    <div id=":tabTip" class="webim-window-tab-tip">                                                            <strong id=":tabTipC"><%=tooltip%></strong>                                                    </div>                                                    <a id=":tabClose" title="<%=close%>" class="webim-window-close" href="#close"><em class="ui-icon ui-icon-close"><%=close%></em></a>                                                    <div id=":tabCount" class="webim-window-tab-count">                                                            0                                                    </div>                                                    <em id=":tabIcon" class="webim-icon webim-icon-comments"></em>                                                    <h4 id=":tabTitle"><%=title%></h4>                                            </div>                                            </div>                                            </div>                                            <div><div id=":window" class="webim-window-window">\t\t\t\t\t\t<iframe id=":bgiframe" class="webim-bgiframe" frameborder="0" tabindex="-1" src="about:blank;" ></iframe>                                                    <div id=":header" class="webim-window-header ui-widget-header ui-corner-top">                                                            <span id=":actions" class="webim-window-actions">                                                                    <a id=":minimize" title="<%=minimize%>" class="webim-window-minimize" href="#minimize"><em class="ui-icon ui-icon-minus"><%=minimize%></em></a>                                                                    <a id=":maximize" title="<%=maximize%>" class="webim-window-maximize" href="#maximize"><em class="ui-icon ui-icon-plus"><%=maximize%></em></a>                                                                    <a id=":close" title="<%=close%>" class="webim-window-close" href="#close"><em class="ui-icon ui-icon-close"><%=close%></em></a>                                                            </span>                                                            <h4 id=":headerTitle"><%=title%></h4>                                                            <div id=":subHeader" class="webim-window-subheader"></div>                                                    </div>                                                    <div id=":content" class="webim-window-content ui-widget-content">                                                    </div>                                            </div>                                            </div>                                            </div>'},
{html:function(a){G(this.$.content,a)},subHeader:function(a){G(this.$.subHeader,a)},_init:function(a,b){b=this.options;var c=this.$;a=this.element;a.window=this;b.tabWidth&&(c.tab.style.width=b.tabWidth+"px");b.subHeader&&this.subHeader(b.subHeader);this.title(b.title,b.icon);!b.minimizable&&B(c.minimize);!b.maximizable&&B(c.maximize);if(!b.closeable){B(c.tabClose);B(c.close)}b.isMinimize?this.minimize():this.restore();b.onlyIcon?B(c.tabTitle):sa(c.tabTip);b.count&&this.notifyUser("information",b.count);
fa(this)},notifyUser:function(a,b){var c=this.$;if(a=="information")if(this.isMinimize())if(ga(c.tabCount,b)){C(c.tab,"ui-state-highlight");J(c.tab,"ui-state-default")}},_count:function(){return ga(this.$.tabCount)},title:function(a,b){var c=this.$,d=c.tabIcon;if(b)if(Ca(b)){d.className="webim-icon";d.style.backgroundImage="url("+b+")"}else d.className="webim-icon webim-icon-"+b;c.tabTipC.innerHTML=a;d=this.options.titleVisibleLength;if(a){for(var f=0,h=[],l=a.split(""),p=l.length,n=0;n<p;n++)if(f>=
d||f<0)break;else{if(l[n].charCodeAt(0)>255)f+=2;else f++;h.push(l[n])}d=h.join("")}else d=a;(c.tabTitle.innerHTML=d)&&a&&d.length<a.length&&c.tabTitle.setAttribute("title",a);c.headerTitle.innerHTML=a},_changeState:function(a){oa(this.element,"webim-window-normal webim-window-maximize webim-window-minimize","webim-window-"+(a=="restore"?"normal":a));this.trigger("displayStateChange",[a])},active:function(){return ia(this.element,"webim-window-active")},activate:function(){if(!this.active()){C(this.element,
"webim-window-active");this.trigger("activate")}},deactivate:function(){if(this.active()){J(this.element,"webim-window-active");this.options.sticky||this.minimize();this.trigger("deactivate")}},_setVisibile:function(){var a=this.$;oa(a.tab,"ui-state-default ui-state-highlight","ui-state-active");this.activate();ga(a.tabCount,0)},maximize:function(){if(!this.isMaximize()){this._setVisibile();this._changeState("maximize")}},restore:function(){if(!ia(this.element,"webim-window-normal")){this._setVisibile();
this._changeState("restore")}},minimize:function(){if(!this.isMinimize()){oa(this.$.tab,"ui-state-active","ui-state-default");this.deactivate();this._changeState("minimize")}},tabClose:function(){this.close()},close:function(){this.trigger("close");sa(this.element)},_initEvents:function(){var a=this,b=a.$,c=b.tab,d=function(f){ja(f);H(f)};z(c,"click",function(f){a.isMinimize()?a.restore():a.minimize();d(f)});z(c,"mouseover",function(){C(this,"ui-state-hover");J(this,"ui-state-default")});z(c,"mouseout",
function(){J(this,"ui-state-hover");this.className.indexOf("ui-state-")==-1&&C(this,"ui-state-default")});z(c,"mousedown",d);T(c);M(za(b.actions.firstChild),function(f,h){ra(h,"ui-state-hover")});M(["minimize","maximize","close","tabClose"],function(f,h){z(b[h],"click",function(l){this.disabled||a[h]();d(l)});z(b[h],"mousedown",d)})},height:function(){return this.$.content.offsetHeight},_fitUI:function(){},isMaximize:function(){return ia(this.element,"webim-window-maximize")},isMinimize:function(){return ia(this.element,
"webim-window-minimize")}});var fa=function(){var a=false,b=function(){a&&a.deactivate();a=false;return true},c=function(){this&&this!=a&&b()&&(a=this)},d=function(){this&&a==this&&(a=false)};z(A,"mousedown",function(f){f=xa(f);for(var h;f;)if(f.id==":webim-window"){h=f;break}else f=f.parentNode;if(h)(f=h.window)&&f.activate();else b()});return function(f){if(f.active()){b();a=f}f.bind("activate",c);f.bind("deactivate",d)}}();aa("layout",function(a){function b(){if(f)return q.updateAllChat();f=true;
var v=p.get("tabs"),x=p.get("tabIds"),I=p.get("p"),U=p.get("a");x&&x.length&&v&&M(v,function($,Ea){var ha=$.slice(2),qa=$.slice(0,1);q.addChat(qa,ha,{},{isMinimize:true});q.chat($).window.notifyUser("information",Ea.n)});I&&(q.prevCount=I)&&q._fitUI();U&&q.focusChat(U)}function c(){var v={};M(q.tabs,function(x,I){v[x]={n:I._count()}});p.set({tabs:v,tabIds:q.tabIds,p:q.prevCount,a:q.activeTabId})}a=a||{};var d=this.im,f=false,h=d.buddy,l=d.history,p=d.status,n=d.setting,r=d.room,q=this.layout=new t.layout(null,
F({chatAutoPop:d.setting.get("msg_auto_pop")},a,{ui:this}));d.setting.get("minimize_layout")?q.collapse():q.expand();d.bind("beforeOnline",function(){q.changeState("ready")}).bind("online",function(v,x){q.changeState("active");q.options.user=x.user;b()}).bind("offline",function(v,x){x=="offline"&&q.removeAllChat();q.updateAllChat();q.changeState("stop")});n.bind("update",function(v,x,I){if("msg_auto_pop"==x)q.options.chatAutoPop=I;else if("minimize_layout"==x)I?q.collapse():q.expand()});h.bind("online",
function(v,x){q.updateChat("buddy",x)}).bind("offline",function(v,x){q.updateChat("buddy",x)}).bind("update",function(v,x){q.updateChat("buddy",x)});q.bind("collapse",function(){n.set("minimize_layout",true)});q.bind("expand",function(){n.set("minimize_layout",false)});q.bind("displayUpdate",function(){c()});(function(){r.bind("addMember",function(v,x,I){(v=q.chat("room",x))&&v.addMember(I.id,I.nick,I.id==d.data.user.id)}).bind("removeMember",function(v,x,I){(v=q.chat("room",x))&&v.removeMember(I.id,
I.nick)})})();d.bind("message",function(v,x){for(var I=false,U=x.length,$,Ea=d.data.user.id,ha,qa,Ha=0;Ha<U;Ha++){$=x[Ha];ha=$.id;type=$.type;(qa=q.chat(type,ha))&&qa.status("");if(!qa){$.type==="chat"?q.addChat(type,ha,null,null,$.nick):q.addChat(type,ha);qa=q.chat(type,ha)}qa&&n.get("msg_auto_pop")&&!q.activeTabId&&q.focusChat(ha);qa.window.notifyUser("information","+1");ha=qa.window.pos;ha==-1&&q.setNextMsgNum("+1");ha==1&&q.setPrevMsgNum("+1");if($.from!=Ea)I=true}if(I){ka.play("msg");ua(s("new message"),
5)}});d.bind("status",function(v,x){M(x,function(I,U){var $=d.data.user.id,Ea=U.from;if(!($!=U.to&&$!=U.from))($=q.chat("buddy",Ea))&&$.status(U.show)})});(function(){l.bind("chat",function(v,x,I){(v=q.chat("chat",x))&&v.history.add(I)});l.bind("grpchat",function(v,x,I){(v=q.chat("grpchat",x))&&v.history.add(I)});l.bind("clear",function(v,x,I){(v=q.chat(x,I))&&v.history.clear()})})();return q});Q("layout",{template:'<div id="webim" class="webim webim-state-ready">\t<div class="webim-preload ui-helper-hidden-accessible">\t<div id="webim-flashlib-c">\t</div>\t</div>\t<div id=":layout" class="webim-layout"><iframe class="webim-bgiframe" frameborder="0" tabindex="-1" src="about:blank;" ></iframe><div class="webim-layout-bg ui-state-default ui-toolbar"></div><div class="webim-ui ui-helper-clearfix">\t<div id=":shortcut" class="webim-shortcut">\t</div>\t<div class="webim-layout-r">\t<div id=":panels" class="webim-panels">\t<div class="webim-window-tab-wrap ui-widget webim-panels-next-wrap">\t<div id=":next" class="webim-window-tab webim-panels-next ui-state-default">\t<div id=":nextMsgCount" class="webim-window-tab-count">\t0\t</div>\t<em class="ui-icon ui-icon-triangle-1-w"></em>\t<span id=":nextCount">0</span>\t</div>\t</div>\t<div id=":tabsWrap" class="webim-panels-tab-wrap">\t<div id=":tabs" class="webim-panels-tab">\t</div>\t</div>\t<div class="webim-window-tab-wrap ui-widget webim-panels-prev-wrap">\t<div id=":prev" class="webim-window-tab webim-panels-prev ui-state-default">\t<div id=":prevMsgCount" class="webim-window-tab-count">\t0\t</div>\t<span id=":prevCount">0</span>\t<em class="ui-icon ui-icon-triangle-1-e"></em>\t</div>\t</div>\t<div class="webim-window-tab-wrap webim-collapse-wrap ui-widget">\t<div id=":collapse" class="webim-window-tab webim-collapse ui-state-default" title="<%=collapse%>">\t<em class="ui-icon ui-icon-circle-arrow-e"></em>\t</div>\t</div>\t<div class="webim-window-tab-wrap webim-expand-wrap ui-widget">\t<div id=":expand" class="webim-window-tab webim-expand ui-state-default" title="<%=expand%>">\t<em class="ui-icon ui-icon-circle-arrow-w"></em>\t</div>\t</div>\t</div>\t<div id=":widgets" class="webim-widgets">\t</div>\t</div>\t</div></div>\t</div>',
shortcutLength:5,chatAutoPop:true,tpl_shortcut:'<div class="webim-window-tab-wrap ui-widget webim-shortcut-item"><a class="webim-window-tab" href="<%=link%>" target="<%=target%>">\t<div class="webim-window-tab-tip">\t<strong><%=title%></strong>\t</div>\t<em class="webim-icon" style="background-image:url(<%=icon%>)"></em>\t</a>\t</div>',chatApp:"chat"},{_init:function(a,b){b=this.options;F(this,{window:y,widgets:{},panels:{},tabWidth:136,maxVisibleTabs:null,animationTime:210,activeTabId:null,tabs:{},
tabIds:[],nextCount:0,prevCount:0});b.unscalable&&C(this.$.layout,"webim-layout-unscalable");b.isMinimize&&this.collapse()},changeState:function(a){this.element.className="webim webim-state-"+a},_ready:false,buildUI:function(){var a=this.$;this.maxVisibleTabs=parseInt(((A.compatMode==="CSS1Compat"&&A.documentElement.clientWidth||A.body.clientWidth)-45-a.shortcut.offsetWidth-a.widgets.offsetWidth-70)/this.tabWidth);this._fitUI();this._autoResizeWindow();this._ready=true},_autoResizeWindow:function(){var a=
this.$.widgets.offsetWidth;for(var b in this.widgets){var c=this.widgets[b]&&this.widgets[b].window;if(c=c&&c.$&&c.$.window)c.style.width=a+"px"}},_updatePrevCount:function(a){var b=this.tabIds,c=this.maxVisibleTabs,d=b.length,f=this.prevCount;if(!(d<=c)){if(a){for(var h=0,l=0;l<d;l++)if(b[l]==a){h=l;break}if(h<=f)f=h;else if(h>=f+c)f=h-c+1}else f=d-c;this.prevCount=f}},_setVisibleTabs:function(a){for(var b=this.prevCount,c=b+this.maxVisibleTabs,d=this.tabs,f=this.tabIds,h=f.length,l=0,p=0,n=0;n<
h;n++){var r=d[f[n]];if(n<b||n>=c)if(a)N(r.element);else{this.activeTabId==f[n]&&r.minimize();var q=r._count();if(n<b){p+=q;r.pos=1}else{l+=q;r.pos=-1}B(r.element)}else{r.pos=0;N(r.element)}}if(!a){this.setNextMsgNum(l);this.setPrevMsgNum(p)}},setNextMsgNum:function(a){ga(this.$.nextMsgCount,a)},setPrevMsgNum:function(a){ga(this.$.prevMsgCount,a)},slideing:false,_slide:function(a){var b=this,c=b.prevCount,d=b.nextCount;if(d>0&&a==-1||c>0&&a==1){b.slideing=true;if(d==1&&a==-1||c==1&&a==1)b.slideing=
false;b._slideSetup(false);b._setVisibleTabs(true);if(a==-1){b.nextCount--;b.prevCount++}else if(a==1){b.nextCount++;b.prevCount--}var f=b.$.tabs,h=parseFloat(f.style.left);c=-1*b.tabWidth*b.nextCount;var l=parseInt(500/13),p=1,n=(c-h)/l,r=setInterval(function(){f.style.left=h+n*p+"px";if(p==l){if(b.slideing)b._slide(a);else{b._fitUI();b._slideReset()}clearInterval(r)}else p++},13)}},_slideUp:function(){this.slideing=false},_slideSetup:function(a){var b=this.$,c=b.tabsWrap;b=b.tabs;if(!this._tabsWidth)this._tabsWidth=
b.clientWidth;if(a)this._tabsWidth=null;c.style.position=a?"":"relative";c.style.overflow=a?"visible":"hidden";c.style.width=a?"":this._tabsWidth+"px";b.style.width=a?"":this.tabWidth*this.tabIds.length+"px";b.style.position=a?"":"relative"},_slideReset:function(){this._slideSetup(true)},_updateCount:function(){var a=this.maxVisibleTabs,b=this.tabIds.length,c=this.prevCount,d=this.nextCount;if(b<=a)c=d=0;else{d=b-a-c;d=d<0?0:d;c=b-a-d}this.prevCount=c;this.nextCount=d},_updateCountUI:function(){var a=
this.$,b=this.prevCount,c=this.nextCount;c<=0?C(a.next,"ui-state-disabled"):J(a.next,"ui-state-disabled");b<=0?C(a.prev,"ui-state-disabled"):J(a.prev,"ui-state-disabled");if(b>0||c>0){a.next.style.display="block";a.prev.style.display="block"}else{B(a.next);B(a.prev)}a.nextCount.innerHTML=c.toString();a.prevCount.innerHTML=b.toString()},_initEvents:function(){var a=this,b=a.$,c=false;z(a.window,"resize",function(){if(c){c=true;a.buildUI()}});z(b.next,"mousedown",function(){a._slide(-1)});z(b.next,
"mouseup",function(){a._slideUp()});T(b.next);z(b.prev,"mousedown",function(){a._slide(1)});z(b.prev,"mouseup",function(){a._slideUp()});T(b.prev);z(b.expand,"click",function(){if(!a.isMinimize())return false;a.expand();a.trigger("expand");return false});z(b.collapse,"click",function(){if(a.isMinimize())return false;a.collapse();a.trigger("collapse");return false});ra(b.collapse,"ui-state-hover","ui-state-default");ra(b.expand,"ui-state-hover","ui-state-default")},isMinimize:function(){return ia(this.$.layout,
"webim-layout-minimize")},collapse:function(){this.isMinimize()||C(this.$.layout,"webim-layout-minimize")},expand:function(){this.isMinimize()&&J(this.$.layout,"webim-layout-minimize")},_displayUpdate:function(){this._ready&&this.trigger("displayUpdate")},_fitUI:function(){this._updateCount();this.$.tabs.style.left=-1*this.tabWidth*this.nextCount+"px";this._updateCountUI();this._setVisibleTabs();this._displayUpdate()},_stickyWin:null,_widgetStateChange:function(a,b){b!="minimize"&&M(this.widgets,
function(c,d){d.window!=a&&d.window.minimize()});this._displayUpdate()},widget:function(a){return this.widgets[a]},addWidget:function(a,b,c,d){var f=this;b=F(b,{closeable:false,subHeader:a.header});var h=a.element;b=new t.window(null,b);b.html(h);f.$[d?d:"widgets"].insertBefore(b.element,c&&f.widgets[c]?f.widgets[c].window.element:null);a.window=b;b.bind("displayStateChange",function(l,p){f._widgetStateChange(this,p)});f.widgets[a.name]=a},focusChat:function(a,b){b=S(a,b);var c=this.tabs[b],d=this.panels[b];
c&&c.isMinimize()&&c.restore();d&&d.focus()},chat:function(a,b){return this.panels[S(a,b)]},updateChat:function(a,b){b=Z(b);for(var c,d=b.length,f,h=0;h<d;h++){c=b[h];(f=this.panels[S(a,c.id)])&&f.update(c)}},updateAllChat:function(){M(this.panels,function(a,b){b.update()})},_onChatClose:function(a){this.tabIds=V(this.tabIds,function(b){return b!=a});delete this.tabs[a];delete this.panels[a];this._changeActive(a,true);this._fitUI()},_onChatChange:function(a,b){if(b=="minimize"){this._changeActive(a,
true);this._displayUpdate()}else{this._changeActive(a);this._fitUI()}},_changeActive:function(a,b){var c=this.activeTabId;if(b)c==a&&(this.activeTabId=null);else{c&&c!=a&&this.tabs[c].minimize();this.activeTabId=a;this._updatePrevCount(a)}},addChat:function(a,b,c,d,f){a=ea(a);var h=this;if(!h.chat(a,b)){var l=h.panels,p=S(a,b);d=h.tabs[p]=(new t.window(null,F({isMinimize:h.activeTabId||!h.options.chatAutoPop,tabWidth:h.tabWidth-2,titleVisibleLength:9},d))).bind("close",function(){h._onChatClose(p)}).bind("displayStateChange",
function(n,r){h._onChatChange(p,r)});a=h.options.ui.addApp(h.options.chatApp,F({id:b,type:a,nick:f,window:d},c));l[p]=a;h.tabIds.push(p);h.$.tabs.insertBefore(d.element,h.$.tabs.firstChild);!d.isMinimize()&&h._changeActive(p);h._fitUI()}},removeChat:function(a,b){var c=this.tabs[S(a,b)];c&&c.close()},removeAllChat:function(){M(this.tabs,function(a,b){b.close()})},addShortcut:function(a){var b=this;if(E(a))M(a,function(f,h){b.addShortcut(h)});else if(O(a)){var c=b.$.shortcut,d=b.options.tpl_shortcut;
if(!(c.childNodes.length>b.options.shortcutLength+1)){d=P(R(d,{title:s(a.title),icon:a.icon,link:a.link,target:a.isExtlink?"_blank":""}));ra(d.firstChild,"ui-state-hover");c.appendChild(d)}}}});Q("history",{user:{},info:{},template:'<div class="webim-history">                        <div id=":content" class="webim-history-content">                 </div></div>'},{_init:function(){ba.call(this,"init",[null,this.ui()])},clear:function(){this.$.content.innerHTML="";this.trigger("clear")},add:function(a){a=
Z(a);var b=a.length,c=[];if(b){for(var d=0;d<b;d++)c.push(this._renderMsg(a[d]));this.$.content.innerHTML+=c.join("");this.trigger("update")}},_renderMsg:function(a){a=F({},a);ba.call(this,"render",[null,this.ui({msg:a})]);var b=a.from,c=a.to,d=a.timestamp,f=a.body,h=true,l=this._lastLogItem,p=[],n;n=a.nick;if(l&&l.to==c&&l.from==b&&d-l.timestamp<6E4)h=false;if(h){this._lastLogItem=a;a=new g(d);p.push('<h4><span class="webim-gray">');p.push(a.getDay(true));p.push(" ");p.push(a.getTime());p.push("</span>");
p.push(n);p.push('</h4><hr class="webim-line ui-state-default" />')}p.push("<p>");p.push(f);p.push("</p>");return p.join("")},_renderDateBreak:function(a){var b=this._lastLogItem,c=new Date,d=new Date,f=[];c.setTime(a);b&&d.setTime(b.timestamp);if(!b||c.getDate()!=d.getDate()||c.getMonth()!=d.getMonth()){f.push("<h5>");f.push((new g(a)).getDay(true));f.push("</h5>")}return f.join("")},ui:function(a){return F({element:this.element,$:this.$},a)},plugins:{}});var ta=function(){function a(d,f,h,l,p,n,
r,q){if(f)return'<a href="'+(f=="www."?"http://"+d:d)+'"'+c+">"+d+"</a>";if(l)return'<a class="webim-img" href="'+n+'"'+c+'><img src="'+(q||n)+'" alt="'+(p||n)+'"/></a>';return'<a class="webim-file" href="'+n+'"'+c+">"+(p||n)+"</a>"}function b(d,f){c+=" "+d+'="'+f+'"'}var c;return function(d,f){c="";f&&O(f)&&M(f,b);return d.replace(/(https?:\/\/|www\.)([^\s<]+)|(\!?)\[([^\]]*)\]\(([^\)]+)\)(\(([^\)]+)\))?/ig,a)}}();t.history.defaults.parseMsg=true;ba.add("history","parseMsg",{render:function(a,b){var c=
b.msg.body;c=na(c);c=ta(c,{target:"_blank"});b.msg.body=c}});t.history.defaults.emot=true;ba.add("history","emot",{render:function(a,b){b.msg.body=t.emot.parse(b.msg.body)}});Q("emot",{template:'<div class="webim-emot ui-widget-content"><%=emots%></div>'},{_init:function(){var a=this,b=a.element;M(b.firstChild.childNodes,function(c,d){z(d,"click",function(){J(b,"webim-emot-show");a.trigger("select",this.firstChild.getAttribute("rel"))})})},template:function(){var a=this.emots=webim.ui.emot.emots,
b=[];b.push('<ul class="ui-helper-clearfix">');M(a,function(c,d){var f=d.src,h=d.t?d.t:d.q[0];b.push('<li><img src="');b.push(f);b.push('" title="');b.push(h);b.push('" alt="');b.push(d.q[0]);b.push('" rel="');b.push(d.q[0]);b.push('" /></li>')});b.push("</ul>");return R(this.options.template,{emots:b.join("")})},toggle:function(){ca(this.element,"webim-emot-show")}});F(t.emot,{emots:[{t:"smile",src:"smile.png",q:[":)"]},{t:"smile_big",src:"smile-big.png",q:[":d",":-d",":D",":-D"]},{t:"sad",src:"sad.png",
q:[":(",":-("]},{t:"wink",src:"wink.png",q:[";)",";-)"]},{t:"tongue",src:"tongue.png",q:[":p",":-p",":P",":-P"]},{t:"shock",src:"shock.png",q:["=-O","=-o"]},{t:"kiss",src:"kiss.png",q:[":-*"]},{t:"glasses_cool",src:"glasses-cool.png",q:["8-)"]},{t:"embarrassed",src:"embarrassed.png",q:[":-["]},{t:"crying",src:"crying.png",q:[":'("]},{t:"thinking",src:"thinking.png",q:[":-/",":-\\"]},{t:"angel",src:"angel.png",q:["O:-)","o:-)"]},{t:"shut_mouth",src:"shut-mouth.png",q:[":-X",":-x"]},{t:"moneymouth",
src:"moneymouth.png",q:[":-$"]},{t:"foot_in_mouth",src:"foot-in-mouth.png",q:[":-!"]},{t:"shout",src:"shout.png",q:[">:o",">:O"]}],init:function(a){var b=webim.ui.emot,c=b._q={};a=F({dir:"webim/static/emot/default"},a);if(a.emots)b.emots=a.emots;var d=a.dir+"/";M(b.emots,function(f,h){if(h&&h.src)h.src=d+h.src;h&&h.q&&M(h.q,function(l,p){c[p]=f})})},parse:function(a){var b=webim.ui.emot._q,c=webim.ui.emot.emots;b&&M(b,function(d,f){var h=c[f],l=h.src,p=h.t?h.t:h.q[0],n=[];n.push('<img src="');n.push(l);
n.push('" title="');n.push(p);n.push('" alt="');n.push(h.q[0]);n.push('" />');d=na(d);d=d.replace(RegExp("(\\"+".$^*\\[]()|+?{}:<>".split("").join("|\\")+")","g"),"\\$1");a=a.replace(RegExp(d,"g"),n.join(""))});return a}});Q("upload",{template:'<div class="webim-upload ui-widget-content"><form class="ui-helper-clearfix" id=":form" method="POST" enctype="multipart/form-data" encoding="multipart/form-data"><input id=":input" type="file" name="files" /><input class="ui-state-default ui-corner-all webim-upload-submit" type="submit" value="<%=upload%>" /></form></div>'},
{_init:function(){var a=this;a.$.form.setAttribute("action",da("upload"));u(a.$.form,function(b){if(b=b&&b[0])if(!b.url||b.error)alert(b.error||"Upload error");else{var c=["image/jpeg","image/jpg","image/gif","image/png"].indexOf(b.type)==-1?"":"!";c+="["+(b.name||"").replace(/\[|\]/ig,"")+"]("+b.url+")";if(b.thumbnailUrl)c+="("+b.thumbnailUrl+")";try{a.$.input.value=""}catch(d){}a.toggle();a.trigger("upload",c)}else alert("Upload error")})},toggle:function(){ca(this.element,"webim-upload-show")}});
aa("chat",function(a){a=a||{};var b=this,c=b.im,d=c.buddy,f=c.room,h=c.history,l=a.id,p=a.type;if(p=="room"){var n=h.get("grpchat",l);n||h.load("grpchat",l);var r=c.room.get(l)||{id:l,nick:a.nick||l};r.presence="online";a=F({emot:true,clearHistory:false,member:true,block:true,downloadHistory:false},b.options.roomChatOptions,{info:r,user:c.data.user,history:n,type:p},a);var q=new t.chat(null,a);q.bind("sendMessage",function(v,x){c.sendMessage(x);h.set(x)}).bind("downloadHistory",function(v,x){h.download("grpchat",
x.id)}).bind("select",function(v,x){x.presence="online";d.presence(x);b.layout.addChat("buddy",x.id,x.nick);b.layout.focusChat("buddy",x.id)}).bind("block",function(v,x){f.block(x.id)}).bind("unblock",function(v,x){f.unblock(x.id)}).bind("destroy",function(){q.options.info.blocked&&f.leave(l)});setTimeout(function(){q.options.info.blocked?f.join(l):f.initMember(l)},500);E(r.members)&&M(r.members,function(v,x){q.addMember(x.id,x.nick,x.id==c.data.user.id)})}else{(n=h.get("chat",l))||h.load("chat",
l);r=c.buddy.get(l)||{id:l,nick:a.nick||l};a=F({emot:true,clearHistory:true},b.options.buddyChatOptions,{info:r,user:c.data.user,history:n,block:false,member:false,msgType:"chat"},a);q=new t.chat(null,a);c.buddy.get(l)||c.buddy.update(l);q.bind("sendMessage",function(v,x){c.sendMessage(x);h.set(x)}).bind("sendStatus",function(v,x){c.sendStatus(x)}).bind("clearHistory",function(v,x){h.clear("chat",x.id)}).bind("downloadHistory",function(v,x){h.download("chat",x.id)})}return q});Q("chat",{tpl_header:'<div><div id=":user" class="webim-user"> \t<a id=":userPic" class="webim-user-pic ui-corner-all ui-state-active" href="#id"><img width="50" height="50" src="" defaultsrc="" onerror="var d=this.getAttribute(\'defaultsrc\');if(d && this.src!=d)this.src=d;" class="ui-corner-all"></a> \t<span id=":userStatus" title="" class="webim-user-status">&nbsp;</span> \t</div></div>',
template:'<div id=":container" class="webim-chat webim-box webim-flex"> \t<div class="webim-chat-notice-wrap1"><div class="webim-chat-notice-wrap"><div id=":notice" class="webim-chat-notice ui-state-highlight"></div></div> </div>\t<div id=":content" class="webim-chat-content webim-flex webim-box-h"> \t<div id=":sidebar" class="webim-chat-sidebar webim-box"></div><div class="webim-flex webim-box"><div id=":main" class="webim-chat-main webim-flex"><div id=":status" class="webim-chat-status webim-gray"></div></div></div> \t</div> \t<div id=":actions" class="webim-chat-actions"> \t<div id=":toolContent" class="webim-chat-tool-content"></div>\t<div id=":tools" class="webim-chat-tools ui-helper-clearfix ui-state-default"></div>\t<table class="webim-chat-t" cellSpacing="0"> \t<tr> \t<td style="vertical-align:top;"> \t<em class="webim-icon webim-icon-chat-edit"></em>\t</td> \t<td style="vertical-align:top;width:100%;"> \t<div class="webim-chat-input-wrap">\t<textarea id=":input" class="webim-chat-input webim-gray ui-widget-content"><%=input notice%></textarea> \t</div> \t</td> \t</tr> \t</table> \t</div> \t</div>'},
{_init:function(){var a=this,b=a.element,c=a.options,d=c.window,f=a.history=new t.history(null,{user:c.user,info:c.info});C(b,"webim-chat-"+c.type);a.$.main.insertBefore(f.element,a.$.main.firstChild);a.header=P(R(c.tpl_header));F(a.$,K(a.header));a._initEvents();d&&a.setWindow(d);c.simple&&B(a.header);a.update(c.info);f.add(c.history);ba.call(a,"init",[null,a.ui()]);setTimeout(function(){a._adjustContent()},0)},setWindow:function(a,b){this.window=a;a.subHeader(this.header);!b&&a.html(this.element);
a.title(this.options.info.nick);this._bindWindow()},update:function(a){if(a){this.options.info=a;this.history.options.info=a;this._updateInfo(a)}a=this.options.info.presence=="online";if(this.options.user.presence=="online")a?this.notice(""):this.notice(s("buddy offline notice",{name:this.options.info.nick}));else this.notice(s("user offline notice"));ba.call(this,"update",[null,this.ui()])},focus:function(){var a=this.$.input;y.setTimeout(function(){try{a.focus()}catch(b){}},0)},_noticeTime:null,
_noticeTxt:"",notice:function(a,b){var c=this,d=c.$.notice,f=c._noticeTime;f&&clearTimeout(f);if(a)if(b){d.innerHTML=a;N(d);setTimeout(function(){if(c._noticeTxt)d.innerHTML=c._noticeTxt;else B(d,500)},b)}else{c._noticeTxt=a;d.innerHTML=a;N(d)}else{c._noticeTxt=null;B(d)}},_adjustContent:function(){var a=this.$.main;if(a.scrollTop!=a.scrollHeight)a.scrollTop=a.scrollHeight},_fitUI:function(){this._adjustContent()},_bindWindow:function(){var a=this;a.window.bind("displayStateChange",function(b,c){if(c!=
"minimize"){y.setTimeout(function(){a.$.input.focus()},0);a._adjustContent()}}).bind("close",function(){a.destroy()})},_inputAutoHeight:function(){var a=this.$.input,b=a[0].scrollTop;if(b>0){var c=a.height();c>32&&c<100&&a.height(c+b)}},sendMessage:function(a){var b=this.options,c=b.info;a={type:b.type=="room"?"grpchat":"chat",to:c.id,from:b.user.id,nick:b.user.nick,to_nick:c.nick,offline:c.presence!="online",timestamp:(new Date).getTime()-g.timeSkew,body:a};ba.call(this,"send",[null,this.ui({msg:a})]);
this.trigger("sendMessage",[a])},_inputkeypress:function(a){if(a.keyCode==13)if(a.ctrlKey){this.insert("\n",true);return true}else{var b=xa(a),c=b.value;if(Y(c).length){this.sendMessage(c);b.value="";H(a)}}else this._typing()},_onFocusInput:function(a){var b=this;xa(a);(y.getSelection?y.getSelection().toString():A.selection?A.selection.createRange().text:"")||y.setTimeout(function(){b.$.input.focus()},0)},_initEvents:function(){var a=this,b=a.$,c=s("input notice"),d=b.input;a.history.bind("update",
function(){a._adjustContent()}).bind("clear",function(){a.notice(s("clear history notice"),3E3)});z(d,"keyup",function(){va.call(this)});z(d,"click",va);z(d,"select",va);z(d,"focus",function(){J(this,"webim-gray");if(this.value==c)this.value=""});z(d,"blur",function(){if(this.value==""){C(this,"webim-gray");this.value=c}});z(d,"keypress",function(f){a._inputkeypress(f)});z(b.main,"click",function(f){a._onFocusInput(f)})},_updateInfo:function(a){var b=this.$;b.userPic.setAttribute("href",a.url);b.userPic.setAttribute("target",
a.target||this.options.target||"");b.userPic.firstChild.setAttribute("defaultsrc",a.default_pic_url?a.default_pic_url:"");setTimeout(function(){if(a.pic_url||a.default_pic_url)try{b.userPic.firstChild.setAttribute("src",a.pic_url||a.default_pic_url)}catch(c){}},100);b.userStatus.innerHTML=ya(a.status)||"&nbsp";this.window&&this.window.title(a.nick,a.show)},insert:function(a,b){var c=this.$.input;c.focus();if(b){a||(a="");if(c.setSelectionRange){var d=c.value,f=c.selectionStart,h=c.selectionEnd,l=
d.substring(0,f);d=d.substring(h);h=a.length;c.value=l+a+d;c.setSelectionRange(f+h,f+h)}else if(A.selection)if(f=c.caretPos){f.text=a;f.collapse();f.select()}else c.value+=a;else c.value+=a}else c.value=a},_statusText:"",sendStatus:function(a){if(!(!a||a==this._statusText||this.options.info.presence=="offline")){this._statusText=a;this.trigger("sendStatus",[{to:this.options.info.id,show:a}])}},_checkST:false,_typing:function(){var a=this;a.sendStatus("typing");a._checkST&&clearTimeout(a._checkST);
a._checkST=y.setTimeout(function(){a.sendStatus("clear")},6E3)},_setST:null,status:function(a){a=a||"clear";var b=this.$.status,c=this.options.info.nick,d="";d=a=="clear"?"":c+s(a);b.innerHTML=d;this._adjustContent();this._setST&&clearTimeout(this._setST);if(d!="")this._setST=y.setTimeout(function(){b.innerHTML=""},1E4)},destroy:function(){this.trigger("destroy")},ui:function(a){return F({self:this,$:this.$,history:this.history},a)},plugins:{}});t.chat.defaults.emot=true;ba.add("chat","emot",{init:function(a,
b){var c=b.self,d=c.emot=new t.emot;d.bind("select",function(h,l){c.focus();c.insert(l,true)});var f=P(R('<a href="#chat-emot" title="<%=emot%>"><em class="webim-icon webim-icon-emot"></em></a>'));z(f,"click",function(h){c.upload&&J(c.upload.element,"webim-upload-show");H(h);d.toggle()});b.$.toolContent.appendChild(d.element);b.$.tools.appendChild(f)},send:function(){}});t.chat.defaults.upload=false;ba.add("chat","upload",{init:function(a,b){var c=b.self,d=c.upload=new t.upload;d.bind("upload",function(h,
l){c.sendMessage(l)});var f=P(R('<a href="#chat-upload" title="<%=upload%>"><em class="webim-icon webim-icon-upload"></em></a>'));z(f,"click",function(h){c.emot&&J(c.emot.element,"webim-emot-show");H(h);d.toggle()});b.$.toolContent.appendChild(d.element);b.$.tools.appendChild(f)},send:function(){}});t.chat.defaults.clearHistory=true;ba.add("chat","clearHistory",{init:function(a,b){var c=b.self,d=P(R('<a href="#chat-clearHistory" title="<%=clear history%>"><em class="webim-icon webim-icon-clear"></em></a>'));
z(d,"click",function(f){H(f);c.trigger("clearHistory",[c.options.info])});b.$.tools.appendChild(d)}});t.chat.defaults.block=true;ba.add("chat","block",{init:function(a,b){var c=b.self,d=c.options.info.blocked,f=c.options.info.nick,h=P('<a href="#chat-block" style="display:'+(d?"none":"")+'" title="'+s("block group",{name:f})+'"><em class="webim-icon webim-icon-unblock"></em></a>'),l=P('<a href="#chat-block" style="display:'+(d?"":"none")+'" title="'+s("unblock group",{name:f})+'"><em class="webim-icon webim-icon-block"></em></a>');
z(h,"click",function(p){H(p);B(h);N(l);c.trigger("block",[c.options.info])});z(l,"click",function(p){H(p);B(l);N(h);c.trigger("unblock",[c.options.info])});b.$.tools.appendChild(h);b.$.tools.appendChild(l)}});t.chat.defaults.member=true;F(t.chat.prototype,{addMember:function(a,b,c){var d=this,f=d.memberLi;if(!f[a]){var h=P('<li><a class="'+(c?"ui-state-disabled":"")+'" href="'+a+'">'+b+"</a></li>");z(h.firstChild,"click",function(l){H(l);c||d.trigger("select",[{id:a,nick:b}])});f[a]=h;d.$.member.appendChild(h);
d.$.memberCount.innerHTML=parseInt(d.$.memberCount.innerHTML)+1}},removeMember:function(a){var b=this.memberLi[a];if(b){this.$.member.removeChild(b);delete this.memberLi[a];this.$.memberCount.innerHTML=parseInt(this.$.memberCount.innerHTML)-1}}});ba.add("chat","member",{init:function(a,b){var c=b.$;b.self.memberLi={};var d=P(R('<div class="webim-box webim-flex  webim-member ui-widget-content ui-corner-left"><iframe id=":bgiframe" class="webim-bgiframe" frameborder="0" tabindex="-1" src="about:blank;" ></iframe><h4><%=room member%>:<span id=":memberCount">0</span></h4><ul id=":ul" class="webim-flex"></ul></div>')),
f=K(d);c.member=f.ul;c.memberCount=f.memberCount;c.sidebar.appendChild(d)}});t.chat.defaults.downloadHistory=true;ba.add("chat","downloadHistory",{init:function(a,b){var c=b.self,d=P(R('<a style="float: right;" href="#chat-downloadHistory" title="<%=download history%>"><em class="webim-icon webim-icon-download"></em></a>'));z(d,"click",function(f){H(f);c.trigger("downloadHistory",[c.options.info])});b.$.tools.appendChild(d)}});aa("setting",function(a){var b=this.im.setting,c=this.layout,d=this.setting=
new t.setting(null,a);c.addWidget(d,{title:s("setting"),icon:"setting",sticky:false,onlyIcon:true,isMinimize:true});b.bind("update",function(f,h,l){typeof l!="object"&&d.check_tag(h,l)});d.bind("change",function(f,h,l){b.set(h,l)})});Q("setting",{template:'<div id="webim-setting" class="webim-setting">\t\t\t<ul id=":ul"><%=tags%></ul>\t\t   </div>',tpl_check:'<li id=":<%=name%>"><input type="checkbox" <%=checked%> id="webim-setting-<%=name%>" name="<%=name%>"/><label for="webim-setting-<%=name%>"><%=label%></label></li>'},
{_init:function(){var a=this.options.copyright;if(a){a=a===true?'<p style="margin: 5px 10px;text-align:right;"><a class="webim-gray" href="http://nextalk.im/" target="_blank">Powered by NextTalk</a></p>':a;this.element.appendChild(P(a))}},template:function(){var a=this,b=[],c=a.options.data;c&&M(c,function(d,f){f&&typeof f!="boolean"||b.push(a._check_tpl(d,f))});return R(a.options.template,{tags:b.join("")})},_initEvents:function(){var a=this,b=a.options.data,c=a.$;b&&M(b,function(d){c[d]&&a._check_event(c[d])})},
_check_tpl:function(a,b){return R(this.options.tpl_check,{label:s(a),name:a,checked:b?'checked="checked"':""})},_check_event:function(a){var b=this;z(a.firstChild,"click",function(){b._change(this.name,this.checked)})},check_tag:function(a,b){var c=this;if(O(a))M(a,function(h,l){c.check_tag(h,l)});else{var d=c.$,f=d[a];if(!(b&&typeof b!="boolean"))if(f)f.firstChild.checked=b;else{f=d[a]=P(c._check_tpl(a,b));c._check_event(f);d.ul.appendChild(f)}}},_change:function(a,b){this.trigger("change",[a,b])},
destroy:function(){}});aa("user",function(a){a=a||{};var b=this.im,c=new t.user;!a.show&&B(c.element);a.container&&a.container.appendChild(c.element);c.bind("online",function(d,f){b.online(f)}).bind("offline",function(){b.offline()}).bind("presence",function(d,f){b.sendPresence(f)});c.update(b.data.user);b.bind("online",function(){N(c.element);c.update(b.data.user)}).bind("offline",function(){c.show("unavailable")});return c});Q("user",{template:'<div>  \t\t<div id=":user" class="webim-user"> \t\t\t<a id=":userPic" class="webim-user-pic ui-corner-all ui-state-active" href="#id"><img width="50" height="50" defaultsrc="" onerror="var d=this.getAttribute(\'defaultsrc\');if(d && this.src!=d)this.src=d;" class="ui-corner-all"></a> \t\t\t\t<div class="webim-user-show"><h4><a  id=":userShowTrigger" href="#show"><strong id=":userNick"></strong><span id=":userShow"><em class="webim-icon webim-icon-unavailable"><%=unavailable%></em><%=unavailable%></span><em class="ui-icon ui-icon-triangle-1-s"><%=show_status_list%></em></a></h4>\t\t\t\t\t<p id=":userShowList" class="ui-state-active ui-corner-all" style="display: none;">\t\t\t\t\t\t<a href="#available" class="webim-user-show-available"><em class="webim-icon webim-icon-available"><%=available%></em><%=available%></a>\t\t\t\t\t\t<a href="#dnd" class="webim-user-show-dnd"><em class="webim-icon webim-icon-dnd"><%=dnd%></em><%=dnd%></a>\t\t\t\t\t\t<a href="#away" class="webim-user-show-away"><em class="webim-icon webim-icon-away"><%=away%></em><%=away%></a>\t\t\t\t\t\t<a href="#invisible" class="webim-user-show-invisible"><em class="webim-icon webim-icon-invisible"><%=invisible%></em><%=invisible%></a>\t\t\t\t\t\t<a href="#unavailable" class="webim-user-show-unavailable"><em class="webim-icon webim-icon-unavailable"><%=unavailable%></em><%=unavailable%></a>\t\t\t\t\t</p>\t\t\t\t</div> \t\t\t\t\t<span id=":userStatus" title="" class="webim-user-status"></span> \t\t\t\t\t\t</div> \t\t\t\t\t\t\t</div>'},
{_init:function(){},_initEvents:function(){var a=this,b=a.$,c=b.userShowList;z(b.userShowTrigger,"click",function(d){c.style.display=="block"?B(c):N(c);H(d)});M(za(c.firstChild),function(d,f){z(f,"click",function(h){a._set(this.href.split("#")[1]);B(c);H(h)})})},update:function(a){var b=a.show||"unavailable",c=this.$;this.options.info=a;c.userStatus.innerHTML=ya(a.status)||"&nbsp;";c.userNick.innerHTML=a.nick||"";c.userPic.setAttribute("href",a.url);c.userPic.firstChild.setAttribute("defaultsrc",
a.default_pic_url?a.default_pic_url:"");setTimeout(function(){if(a.pic_url||a.default_pic_url)c.userPic.firstChild.setAttribute("src",a.pic_url||a.default_pic_url)},100);this.show(b)},show:function(a){var b=s(a);this.$.userShow.innerHTML='<em class="webim-icon webim-icon-'+a+'">'+b+"</em>"+b},_set:function(a){var b=this.options.info;this.show(a);if(b){if(b.show!=a)if(a=="unavailable")this.trigger("offline",[]);else b.show=="unavailable"?this.trigger("online",[{show:a}]):this.trigger("presence",[{show:a,
status:b.status}])}else a!="unavailable"&&this.trigger("online",[{show:a}])},destroy:function(){}});aa("login",function(a){a=a||{};var b=this.im,c=new t.login(null,a);a.container&&a.container.appendChild(c.element);c.bind("login",function(d,f){b.online(f)});b.bind("online",function(){c.hide()}).bind("offline",function(d,f,h){f=="online"&&c.showError(h)});return c});Q("login",{questions:null,notice:"",template:'<div id=":login" class="webim-login"> \t\t\t<div class="webim-login-logo" id=":logo"></div>\t\t\t<div class="webim-login-notice" id=":notice"></div>\t\t\t<div class="ui-state-error webim-login-error ui-corner-all" style="display: none;" id=":error"></div>\t\t\t<form id=":form">\t\t\t\t<p class="ui-helper-clearfix"><label for=":username"><%=username%></label><input name="username" id=":username" type="text" /></p>\t\t\t\t<p class="ui-helper-clearfix"><label for=":password"><%=password%></label><input name="password" id=":password" type="password" /></p>\t\t\t\t<div id=":more">\t\t\t\t<p class="ui-helper-clearfix"><label for=":question"><%=question%></label><select name="question" id=":question" ></select></p>\t\t\t\t<p class="ui-helper-clearfix"><label for=":answer"><%=answer%></label><input name="answer" id=":answer" type="text" /></p>\t\t\t\t</div>\t\t\t\t<p class="ui-helper-clearfix"><input name="submit" id=":submit" class="ui-state-default ui-corner-all webim-login-submit" value="<%=login%>" type="submit" /></p>\t\t\t</form>\t\t</div>'},
{_init:function(){var a=this.options.questions,b=this.$;a&&a.length?M(a,function(c,d){var f=A.createElement("option");f.value=d[0];f.innerHTML=d[1];b.question.appendChild(f)}):B(b.more);b.notice.innerHTML=this.options.notice},_initEvents:function(){var a=this,b=a.$;ra(b.submit,"ui-state-hover");z(b.form,"submit",function(c){H(c);a.trigger("login",[{username:b.username.value,password:b.password.value,question:b.question.value,answer:b.answer.value}])})},hide:function(){B(this.element)},show:function(){N(this.element)},
hideError:function(){B(this.$.error)},showError:function(a){var b=this.$.error;b.innerHTML=s(a);N(b)},destroy:function(){}});aa("buddy",function(a){a=a||{};var b=this,c=b.im,d=c.buddy,f=b.layout,h=new t.buddy(null,F({title:a.title||s("buddy")},a));f.addWidget(h,{className:"webim-buddy-window",title:a.title||s("buddy"),titleVisibleLength:19,sticky:c.setting.get("buddy_sticky"),isMinimize:!c.status.get("b"),icon:"buddy"});h.bind("select",function(q,v){b.layout.addChat("buddy",v.id);b.layout.focusChat("buddy",
v.id)});var l;if(!a.disable_user){l=b.addApp("user",a.userOptions);if(a.is_login){h.window.subHeader(l.element);N(l.element);l=null}}!a.is_login&&!a.disable_login&&b.addApp("login",F({container:h.$.content},a.loginOptions));c.setting.bind("update",function(q,v){if(q=="buddy_sticky")h.window.option.sticky=v});h.window&&h.window.bind("displayStateChange",function(q,v){if(v!="minimize"){d.options.active=true;c.status.set("b",1);d.complete()}else{c.status.set("b",0);d.options.active=false}});var p=function(q){return O(q)?
q.id:q},n=function(q){return q.show!="invisible"&&q.presence=="online"},r=function(q){return q.show=="invisible"};d.bind("online",function(q,v){h.add(V(v,n));h.update(v)});d.bind("offline",function(q,v){if(a.showUnavailable){h.remove(Aa(v,p));h.add(v)}else h.remove(Aa(v,p))});d.bind("update",function(q,v){h.add(V(v,n));h.update(V(v,n));h.remove(Aa(V(v,r),p))});h.offline();c.bind("beforeOnline",function(){h.online()}).bind("online",function(){l&&h.window.subHeader(l.element);h.titleCount()}).bind("offline",
function(){h.offline()});return h});Q("buddy",{template:'<div id="webim-buddy" class="webim-buddy webim-flex webim-box">\t\t<div id=":search" class="webim-buddy-search ui-state-default ui-corner-all"><em class="ui-icon ui-icon-search"></em><input id=":searchInput" type="text" value="" /></div>\t\t\t<div class="webim-buddy-content webim-flex" id=":content">\t\t\t\t<div id=":empty" class="webim-buddy-empty"><%=empty buddy%></div>\t\t\t\t\t<ul id=":ul"></ul>\t\t\t\t\t\t</div>\t\t\t\t\t\t\t</div>',tpl_group:'<li><h4><%=title%>(<%=count%>)</h4><hr class="webim-line ui-state-default" /><ul></ul></li>',
tpl_li:'<li title=""><a href="<%=url%>" rel="<%=id%>" class="ui-helper-clearfix"><div id=":tabCount" class="webim-window-tab-count">0</div><em class="webim-icon webim-icon-<%=show%>" title="<%=human_show%>"><%=show%></em><img width="25" src="<%=pic_url%>" defaultsrc="<%=default_pic_url%>" onerror="var d=this.getAttribute(\'defaultsrc\');if(d && this.src!=d)this.src=d;" /><strong><%=nick%></strong><span><%=status%></span></a></li>'},{_init:function(){var a=this.options;this.groups={};this.li={};this.li_group=
{};this.size=0;a.disable_group&&C(this.element,"webim-buddy-hidegroup");a.simple&&C(this.element,"webim-buddy-simple")},_initEvents:function(){var a=this,b=a.$,c=b.search,d=b.searchInput,f=s("search buddy");z(c.firstChild,"click",function(){d.focus()});d.value=f;z(d,"focus",function(){C(c,"ui-state-active");if(this.value==f)this.value=""});z(d,"blur",function(){J(c,"ui-state-active");if(this.value=="")this.value=f});z(d,"keyup",function(){var h=this.value;M(a.li,function(l,p){h&&(p.text||p.innerHTML.replace(/<[^>]*>/g,
"")).indexOf(h)==-1?B(p):N(p)})})},titleCount:function(){var a=this.size,b=this.window,c=this.$.empty;b&&b.title(this.options.title+"("+(a?a:"0")+")");a?B(c):N(c);a>8?this.scroll(true):this.scroll(false)},scroll:function(a){ca(this.element,"webim-buddy-scroll",a)},_time:null,_titleBuddyOnline:function(a){var b=this;a||(a="");b._time&&clearTimeout(b._time);b._time=setTimeout(function(){b.titleCount()},5E3)},_title:function(a){var b=this.window;b&&b.title(this.options.title+"["+s(a)+"]")},notice:function(a,
b){switch(a){case "buddyOnline":this._titleBuddyOnline(b);break;default:this._title(a)}},online:function(){var a=this.$;this.notice("connect");B(a.empty)},offline:function(){var a=this.$;this.scroll(false);this.removeAll();B(a.empty);this.notice("offline")},_updateInfo:function(a,b){a=a.firstChild;a.setAttribute("href",b.url);a=a.firstChild;a=a.nextSibling;var c=b.show?b.show:"available";a.className="webim-icon webim-icon-"+c;a.setAttribute("title",s(c));a=a.nextSibling;a.setAttribute("defaultsrc",
b.default_pic_url?b.default_pic_url:"");if(b.pic_url||b.default_pic_url)a.setAttribute("src",b.pic_url||b.default_pic_url);a=a.nextSibling;a.innerHTML=b.nick;a=a.nextSibling;a.innerHTML=ya(b.status)||"&nbsp;";return a},showCount:function(a,b){var c=this.li;c[a]&&ga(c[a].firstChild.firstChild,b)},_addOne:function(a,b){var c=this,d=c.li,f=a.id,h=c.$.ul;if(!d[f]){c.size++;if(!a.default_pic_url)a.default_pic_url="";a.status=ya(a.status)||"&nbsp;";a.show=a.show||"available";a.human_show=s(a.show);a.pic_url=
a.pic_url||"";d=d[f]=P(R(c.options.tpl_li,a));z(d.firstChild,"click",function(n){H(n);c.showCount(f,0);c.trigger("select",[a]);this.blur()});var l=c.groups,p=s(a.group||"friend");l=l[p];if(!l){l=P(R(c.options.tpl_group));B(l);if(p==s("stranger"))b=true;b?h.appendChild(l):h.insertBefore(l,h.firstChild);l={name:p,el:l,count:0,title:l.firstChild,li:l.lastChild};c.groups[p]=l}l.count==0&&N(l.el);c.li_group[f]=l;l.li.appendChild(d);l.count++;l.title.innerHTML=p+"("+l.count+")"}},_updateOne:function(a){var b=
this.li,c=a.id;b[c]&&this._updateInfo(b[c],a)},update:function(a){a=Z(a);for(var b=0;b<a.length;b++)this._updateOne(a[b])},add:function(a,b){a=Z(a);for(var c=0;c<a.length;c++)this._addOne(a[c],b);this.titleCount()},removeAll:function(){var a=[],b=this.li;for(var c in b)a.push(c);this.remove(a);this.titleCount()},remove:function(a){var b,c,d=this.li,f,h=this.li_group;a=w(a);for(var l=0;l<a.length;l++){b=a[l];if(c=d[b]){this.size--;if(f=h[b]){f.count--;f.count==0&&B(f.el);f.title.innerHTML=f.name+"("+
f.count+")"}sa(c);delete d[b]}}this.titleCount()},select:function(a){(a=this.li[a])&&a.firstChild.click();return a},active:function(a){if(this.options.highlightable){this._actived&&J(this._actived.firstChild,"ui-state-default ui-state-highlight");if(a){if(a=this.li[a]){C(a.firstChild,"ui-state-default ui-state-highlight");this._actived=a}}else this._actived=null}},destroy:function(){}});aa("room",function(a){function b(n,r){var q=n.nick;n=F({},n,{group:"group",nick:q+"("+(parseInt(n.count)+"/"+parseInt(n.all_count||
n.count))+")"});h.updateChat(n);n.blocked&&(n.nick=q+"("+s("blocked")+")");p.li[n.id]?p.update(n):!r&&p.add(n)}var c=this.im,d=c.room,f=c.setting,h=this.layout,l=c.buddy,p=this.room=(new webim.ui.room(null,F(a,{buddy:l,user:c.data.user}))).bind("select",function(n,r){h.addChat("room",r.id);h.focusChat("room",r.id)}).bind("discussion",function(n,r,q){r.id=r.id||L();d.join(r.id,r.nick,function(){h.addChat("room",r.id);h.focusChat("room",r.id)});for(n=0;n<q.length;n++){var v=q[n];(function(x,I){setTimeout(function(){c.sendMessage(x)},
I*500)})({type:"chat",to:v,from:c.data.user.id,nick:c.data.user.nick,to_nick:l.get(v)&&l.get(v).nick,timestamp:(new Date).getTime(),body:"webim-event:invite|,|"+r.id+"|,|"+r.nick},n)}});c.bind("event",function(n,r){for(var q=0;q<r.length;q++){var v=r[q].event;v&&v[0]=="invite"&&d.join(v[1],v[2],function(){})}});h.addWidget(p,{title:s("room"),icon:"room",sticky:c.setting.get("buddy_sticky"),onlyIcon:true,isMinimize:true});c.setting.bind("update",function(n,r,q){if(r=="buddy_sticky")p.window.options.sticky=
q});d.bind("join",function(n,r){b(r);if(r.temporary){for(var q=[],v=f.get("temporary_rooms")||[],x=false,I=false,U=0;U<v.length;U++){if(v[U].id==r.id){x=true;I=v[U].nick!=r.nick;v[U].nick=r.nick}q.push(v[U])}x||q.push({id:r.id,nick:r.nick});if(!x||I)f.set("temporary_rooms",q)}}).bind("leave",function(n,r){if(r.temporary){for(var q=[],v=f.get("temporary_rooms")||[],x=false,I=0;I<v.length;I++)if(v[I].id==r.id)x=true;else q.push(v[I]);x&&f.set("temporary_rooms",q);p.remove(r.id)}}).bind("block",function(n,
r,q){n=d.get(r);f.set("blocked_rooms",q);b(n);d.leave(r)}).bind("unblock",function(n,r,q){n=d.get(r);f.set("blocked_rooms",q);b(n);d.join(r,n&&n.nick)}).bind("addMember",function(n,r){b(d.get(r),true)}).bind("removeMember",function(n,r){b(d.get(r),true)})});Q("room",{template:'<div id="webim-room" class="webim-room webim-flex webim-box">\t<div id=":list">\t<div id=":search" class="webim-room-search ui-state-default ui-corner-all"><em class="ui-icon ui-icon-search"></em><input id=":searchInput" type="text" value="" /></div>\t<div class="webim-room-content webim-flex">\t<div id=":empty" class="webim-room-empty"><%=empty room%></div>\t<ul id=":ul"></ul>\t</div>\t</div>\t<div id=":discussion" style="display:none;" class="webim-room-discussion">\t<h4><%=discussion%></h4>\t<div><p><%=discussion name%></p><input id=":name" class="webim-room-discussion-name" type="text" /></div>\t<div><p><%=select discussion buddies%></p><ul class="webim-room-discussion-list ui-widget-content" id=":ul2"></ul></div>\t<div><a id=":confirm" href="#" class="webim-button ui-state-default ui-corner-all"><%=confirm%></a><a id=":cancel" href="#" class="webim-button ui-state-default ui-corner-all"><%=cancel%></a></div>\t</div>\t<div id=":actions" class="webim-room-actions"><a id=":create" href="#" class="webim-button ui-state-default ui-corner-all"><%=create discussion%></a></div>\t</div>',
tpl_li:'<li title=""><input class="webim-button ui-state-default ui-corner-all" type="button" value="<%=invite%>" /><a href="<%=url%>" rel="<%=id%>" class="ui-helper-clearfix"><div id=":tabCount" class="webim-window-tab-count">0</div><img width="25" src="<%=pic_url%>" defaultsrc="<%=default_pic_url%>" onerror="var d=this.getAttribute(\'defaultsrc\');if(d && this.src!=d)this.src=d;" /><strong><%=nick%></strong></a></li>'},{_init:function(){this.size=0;this.li={};this._count=0;N(this.$.empty);this.options.discussion||
B(this.$.create)},_initEvents:function(){var a=this,b=a.$,c=b.search,d=b.searchInput,f=s("search room");z(c.firstChild,"click",function(){d.focus()});d.value=f;z(d,"focus",function(){C(c,"ui-state-active");if(this.value==f)this.value=""});z(d,"blur",function(){J(c,"ui-state-active");if(this.value=="")this.value=f});z(d,"keyup",function(){var h=this.value;M(a.li,function(l,p){h&&(p.text||p.innerHTML.replace(/<[^>]*>/g,"")).indexOf(h)==-1?B(p):N(p)})});z(b.create,"click",function(h){H(h);a.updateDiscussion()});
z(b.confirm,"click",function(h){H(h);a.confirmDiscussion()});z(b.cancel,"click",function(h){H(h);a.confirmDiscussion(true)})},scroll:function(a){ca(this.element,"webim-room-scroll",a)},_updateInfo:function(a,b){a=a.firstChild.nextSibling;a.setAttribute("href",b.url);a=a.firstChild.nextSibling;a.setAttribute("defaultsrc",b.default_pic_url?b.default_pic_url:"");a.setAttribute("src",b.pic_url);a=a.nextSibling;a.innerHTML=b.nick;return a},_addOne:function(a){var b=this,c=b.li,d=a.id,f=b.$.ul;b.size++;
if(!c[d]){if(!a.default_pic_url)a.default_pic_url="";c=c[d]=P(R(b.options.tpl_li,a));var h=c.firstChild;a.temporary?z(h,"click",function(l){H(l);b.updateDiscussion(a)}):B(h);z(h.nextSibling,"click",function(l){H(l);b.showCount(d,0);b.trigger("select",[a]);this.blur()});f.appendChild(c)}},_updateOne:function(a){var b=this.li,c=a.id;b[c]&&this._updateInfo(b[c],a)},update:function(a){a=Z(a);for(var b=0;b<a.length;b++)this._updateOne(a[b])},add:function(a){B(this.$.empty);a=Z(a);for(var b=0;b<a.length;b++)this._addOne(a[b]);
this.size>8&&this.scroll(true)},removeAll:function(){var a=[],b=this.li;for(var c in b)a.push(c);this.remove(a)},remove:function(a){var b,c,d=this.li;a=w(a);for(var f=0;f<a.length;f++){b=a[f];if(c=d[b]){sa(c);delete d[b]}}},select:function(a){(a=this.li[a])&&a.firstChild.click();return a},destroy:function(){},confirmDiscussion:function(a){var b=this.$;B(b.discussion);N(b.list);N(b.actions);if(!a){a=this._discussion||{};a.temporary=true;a.nick=b.name.value||s("discussion");b=b.ul2.getElementsByTagName("input");
for(var c=[],d=0;d<b.length;d++){var f=b[d];f.checked&&c.push(f.value)}this.trigger("discussion",[a,c])}},updateDiscussion:function(a){var b=[],c=this.options.buddy.all(true);this._discussion=a;var d=this.$;d.name.value=a&&a.nick.replace(/\([^\)]*\)/ig,"")||this.options.user.nick+"\u7684\u8ba8\u8bba\u7ec4";for(a=0;a<c.length;a++){var f=c[a];b.push('<li><label for="webim-discussion-'+f.id+'"><input id="webim-discussion-'+f.id+'" type="checkbox" name="buddy" value="'+f.id+'" />'+f.nick+"</label></li>")}d.ul2.innerHTML=
b.join("");N(d.discussion);B(d.list);B(d.actions)},showCount:function(a,b){var c=this.li;c[a]&&ga(c[a].firstChild.nextSibling.firstChild,b)},active:function(a){if(this.options.highlightable){this._actived&&J(this._actived.firstChild.nextSibling,"ui-state-default ui-state-highlight");if(a){if(a=this.li[a]){C(a.firstChild.nextSibling,"ui-state-default ui-state-highlight");this._actived=a}}else this._actived=null}}});aa("menu",function(a){var b=this.layout;a=this.menu=new t.menu(null,a);b.addWidget(a,
{title:s("menu"),icon:"home",sticky:false,onlyIcon:false,isMinimize:true},null,"shortcut")});Q("menu",{template:'<div id="webim-menu" class="webim-menu">\t\t<ul id=":ul"><%=list%></ul>\t\t\t<div id=":empty" class="webim-menu-empty"><%=empty menu%></div>\t\t\t\t</div>',tpl_li:'<li><a href="<%=link%>" target="<%=target%>"><img src="<%=icon%>"/><span><%=title%></span></a></li>'},{_init:function(){var a=this.options;a.data&&a.data.length&&B(this.$.empty)},template:function(){var a=this,b=[],c=a.options.data;
c&&M(c,function(d,f){b.push(a._li_tpl(f))});return R(a.options.template,{list:b.join("")})},_li_tpl:function(a){return R(this.options.tpl_li,{title:s(a.title),icon:a.icon,link:a.link,target:a.isExtlink?"_blank":""})},_fitUI:function(){var a=this.element;if(a.clientHeight>300)a.style.height="300px"},add:function(a){var b=this;if(E(a))M(a,function(d,f){b.add(f)});else{var c=b.$;B(c.empty);c.ul.appendChild(P(b._li_tpl(a)))}},destroy:function(){}});aa("chatlink2",function(a){var b=this,c=b.im,d=b.chatlink2=
(new webim.ui.chatlink2(null,a)).bind("select",function(l,p){b.im.online();b.layout.addChat("buddy",p);b.layout.focusChat("buddy",p)}),f=function(l){return l.show!="invisible"&&l.presence=="online"},h=function(l){return l.show=="invisible"};c.buddy.bind("online",function(l,p){d.on(V(p,f))}).bind("update",function(l,p){d.on(V(p,f));d.off(V(p,h))}).bind("offline",function(l,p){d.off(p)});c.bind("beforeOnline",function(l,p){p.stranger_ids=d.idsArray()}).bind("online",function(){d.off(c.data.user)}).bind("offline",
function(){d.offAll()})});Q("chatlink2",{wrap:null,re_id:[/chat\/([^\/]+)/i],className:/webim-chat/},{_init:function(){function a(p,n){if(!p)return false;if(!n)return false;for(var r=n.length,q=0;q<r;q++){var v=n[q].exec(p);if(v&&v[1])return v[1]}return false}var b=this,c=b.list={},d=b.options,f=b.anthors={},h=d.re_id,l=d.className;(d=(d.wrap||A).getElementsByTagName("a"))&&M(d,function(p,n){var r=a(n.href,h),q=n.innerHTML;if(r&&za(n.firstChild).length==0&&q&&l.test(n.className)){f[r]?f[r].push(n):
f[r]=[n];c[r]={id:r,name:q};q=P('<a class="webim-chatlink2"><em>');n.appendChild(q);n.icon=q;n.title=s("offline");n.id=r;z(n,"click",function(v){b.trigger("select",this.id);ja(v);H(v)})}})},idsArray:function(){var a=[];M(this.list,function(b){a.push(b)});return a},on:function(a){var b=this.list,c=this.anthors,d=a.length,f,h,l;for(f=0;f<d;f++){h=a[f];if(h.id&&(l=h.uid||h.id)&&b[l])if(h=c[l])for(var p=0;p<h.length;p++){var n=h[p];n&&n.icon&&C(n.icon,"webim-chatlink2-online");n&&(n.title=s("available"))}}},
off:function(a){var b=this.list,c=this.anthors,d=a.length,f,h,l;for(f=0;f<d;f++){h=a[f];if(h.id&&(l=h.uid||h.id)&&b[l])if(h=c[l])for(var p=0;p<h.length;p++){var n=h[p];n&&n.icon&&J(n.icon,"webim-chatlink2-online");n&&(n.title=s("unavailable"))}}},offAll:function(){M(this.anthors,function(a,b){b&&M(b,function(c,d){d&&d.icon&&J(d.icon,"webim-chatlink2-online");d&&(d.title=s("unavailable"))})})}});Fa("notification",{url:"webim/notifications"},{_init:function(){},grep:function(a){return a&&a.text},handle:function(a){a=
V(Z(a),this.grep);a.length&&this.trigger("data",[a])},load:function(){W({url:da("notifications"),cache:false,context:this,success:this.handle})}});aa("notification",function(a){var b=this.im,c=this.layout,d=this.notification=new t.notification(null,a),f=b.notification=new webim.notification(null,{jsonp:b.options.jsonp});c.addWidget(d,{title:s("notification"),icon:"notification",sticky:false,onlyIcon:true,isMinimize:true});f.bind("data",function(h,l){d.window.notifyUser("information","+"+l.length);
d.add(l)});setTimeout(function(){f.load()},2E3)});Q("notification",{template:'<div id="webim-notification" class="webim-notification">\t<ul id=":ul"><%=list%></ul>\t<div id=":empty" class="webim-notification-empty"><%=empty notification%></div>\t</div>',tpl_li:'<li><a href="<%=link%>" target="<%=target%>"><%=text%></a></li>'},{_init:function(){var a=this.options;a.data&&a.data.length&&B(this.$.empty)},template:function(){var a=this,b=[],c=a.options.data;c&&M(c,function(d,f){b.push(a._li_tpl(f))});
return R(a.options.template,{list:b.join("")})},_li_tpl:function(a){return R(this.options.tpl_li,{text:a.text,link:a.link,target:this.options.target||a.target||""})},_fitUI:function(){var a=this.element;if(a.clientHeight>300)a.style.height="300px"},add:function(a){var b=this;if(E(a))M(a,function(d,f){b.add(f)});else{var c=b.$;B(c.empty);c.ul.appendChild(P(b._li_tpl(a)))}},destroy:function(){}});aa("layout.popup",function(a){t.buddy&&(t.buddy.defaults.highlightable=true);t.room&&(t.room.defaults.highlightable=
true);t.chat&&(t.chat.defaults.simple=true);a=a||{};var b=this.im,c=b.buddy,d=b.history,f=b.status,h=b.room,l=new t["layout.popup"](null,F({},a,{ui:this}));(function(){b.bind("online",function(p,n){l.options.user=n.user;l.updateAllChat()}).bind("offline",function(){l.updateAllChat()})})();(function(){b.bind("beforeOnline",function(r,q){F(q,{buddy_ids:f.get("_cacheBuddy"),room_ids:"",show:"available"})});var p=function(r){return r&&r.id},n=function(){var r=Aa(c.all(true),p);f.set("_cacheBuddy",r.join(","));
l.updateAllChat()};c.bind("online",n).bind("offline",n)})();(function(){h.bind("addMember",function(p,n,r){(p=l.chat("room",n))&&p.addMember(r.id,r.nick,r.id==b.data.user.id)}).bind("removeMember",function(p,n,r){(p=l.chat("room",n))&&p.removeMember(r.id,r.nick)})})();(function(){d.bind("chat",function(p,n,r){(p=l.chat("chat",n))&&p.history.add(r)});d.bind("grpchat",function(p,n,r){(p=l.chat("grpchat",n))&&p.history.add(r)});d.bind("clear",function(p,n,r){(p=l.chat(n,r))&&p.history.clear()})})();
b.bind("message",function(p,n){for(var r=false,q=n.length,v,x=b.data.user.id,I,U,$=0;$<q;$++){v=n[$];I=v.id;type=v.type==="chat"?"buddy":"room";(U=l.chat(type,I))&&U.status("");if(!U){(U=l.widget(type))&&U.showCount(I,"+1");l.notifyUser(type,"+1")}if(v.from!=x)r=true}if(r){ka.play("msg");ua(s("new message"),5)}});b.bind("status",function(p,n){M(n,function(r,q){var v=b.data.user.id,x=q.from;if(!(v!=q.to&&v!=q.from))(v=l.chat("buddy",x))&&v.status(q.show)})});return l});Q("layout.popup",{template:'<div id="webim" class="webim webim-state-ready">\t<div class="webim-preload ui-helper-hidden-accessible">\t<div id="webim-flashlib-c">\t</div>\t</div>\t<div id=":layout" class="webim-layout webim-popup ui-helper-clearfix"><div id=":left" class="webim-popup-left"></div><div id=":right" class="webim-popup-right"></div>\t<div id=":widgets" class="webim-widgets ui-widget-content ui-helper-clearfix"><div class="webim-layout-bg ui-state-default ui-toolbar"></div></div>\t</div>\t</div>',
template_tab:'<div class="webim-window-tab-wrap">\t<div id=":tab" class="webim-window-tab ui-state-default">\t<div class="webim-window-tab-inner">\t<div id=":tabTip" class="webim-window-tab-tip">\t<strong id=":tabTipC"><%=title%></strong>\t</div>\t<div id=":tabCount" class="webim-window-tab-count">\t0\t</div>\t<em id=":tabIcon" class="webim-icon webim-icon-<%=icon%>"></em>\t</div>\t</div>\t</div>'},{_init:function(){F(this,{widgets:{},widgetIds:[],tabs:{},activeTabId:null});this.win=new t.window(null,
{closeable:false,minimizable:false,isMinimize:false})},buildUI:function(){var a=this.win;a.$.window.appendChild(this.$.widgets);this.$.left.appendChild(a.element)},widget:function(a){return this.widgets[a]},addWidget:function(a,b){var c=this.win,d=a.name;a.window=c;this.widgetIds.push(d);this.widgets[a.name]=a;B(a.element);c.$.content.appendChild(a.element);this._createTab(d,b);this.widgetIds.length==1&&this._activeTab(d)},_createTab:function(a,b){var c=this,d=P(R(c.options.template_tab,b));d.$=K(d);
var f=d.$.tab;z(f,"click",function(h){c._activeTab(a);ja(h);H(h)});z(f,"mouseover",function(){C(this,"ui-state-hover");J(this,"ui-state-default")});z(f,"mouseout",function(){J(this,"ui-state-hover");this.className.indexOf("ui-state-")==-1&&C(this,"ui-state-default")});T(f);c.$.widgets.appendChild(d);c.tabs[a]=d},_activeTab:function(a){for(var b=this.tabs,c=this.widgetIds.length-1;c>=0;c--){var d=this.widgetIds[c],f=this.widgets[d],h=b[d].$.tab;if(d==a){N(f.element);C(h,"ui-state-active");J(h,"ui-state-default");
ga(b[d].$.tabCount,0)}else if(d==this.activeTabId){B(f.element);C(h,"ui-state-default");J(h,"ui-state-active")}}this.activeTabId=a},notifyUser:function(a,b){if(a!=this.activeTabId){var c=this.tabs[a];c&&ga(c.$.tabCount,b)}},focusChat:function(){},chat:function(a,b){if(!a||this.__chat&&this.__chat.__id==S(a,b))return this.__chat;return null},updateChat:function(){var a=this.chat();a&&a.update()},updateAllChat:function(){this.updateChat()},addChat:function(a,b,c,d,f){a=ea(a);var h=this;h.__chat&&sa(h.__chat.window.element);
var l=h.widget(a=="room"?"buddy":"room");l&&l.active(null);(l=h.widget(a))&&l.active(b);var p=(new t.window(null,F({minimizable:false},d))).bind("close",function(){h.__chat=null;l&&l.active()});c=h.__chat=h.options.ui.addApp("chat",F({},h.options.ui.options[a+"ChatOptions"],{id:b,type:a,nick:f,winOptions:d},c));c.__id=S(a,b);c.setWindow(p);h.$.right.appendChild(p.element)}})})(window,document);
